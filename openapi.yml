openapi: 3.0.3
info:
  title: S3Desk API
  version: 0.1.0
  description: |
    Draft API spec for S3Desk, a local-only (127.0.0.1) dashboard targeting S3-compatible object storage.
    - Metadata/browsing and downloads are powered by `rclone`.
    - Bulk transfers run as Jobs powered by `rclone`.
servers:
  - url: http://127.0.0.1:8080/api/v1
    description: Default local server
tags:
  - name: Profiles
  - name: Buckets
  - name: Objects
  - name: Uploads
  - name: Jobs
  - name: Events
  - name: System
paths:
  /ws:
    get:
      tags: [Events]
      summary: WebSocket event stream
      description: |
        Upgrades to a WebSocket and streams `job.*` events.

        If `API_TOKEN` is configured, browsers should pass it via query `?apiToken=...` (WebSocket cannot set custom headers).

        Optional: `afterSeq` can be used to replay buffered (non-log) events after a given sequence number.
      parameters:
        - $ref: "#/components/parameters/XApiToken"
        - name: apiToken
          in: query
          required: false
          schema: { type: string }
        - name: afterSeq
          in: query
          required: false
          schema: { type: integer, format: int64, minimum: 0 }
        - name: includeLogs
          in: query
          required: false
          description: Whether to include `job.log` events in the stream.
          schema: { type: boolean, default: true }
      responses:
        "101":
          description: Switching Protocols
        "401":
          $ref: "#/components/responses/ErrorResponse"
        "403":
          $ref: "#/components/responses/ErrorResponse"

  /events:
    get:
      tags: [Events]
      summary: Server-sent events (SSE) stream
      description: |
        Streams `job.*` events using `text/event-stream` (one JSON event per `data:` line).

        If `API_TOKEN` is configured, browsers should pass it via query `?apiToken=...` (EventSource cannot set custom headers).

        Each message includes an SSE `id:` equal to the server-side event `seq`. When reconnecting, clients may send `Last-Event-ID` (or `afterSeq`) to receive buffered (non-log) events that were missed.
      parameters:
        - $ref: "#/components/parameters/XApiToken"
        - name: apiToken
          in: query
          required: false
          schema: { type: string }
        - name: Last-Event-ID
          in: header
          required: false
          schema: { type: integer, format: int64, minimum: 0 }
        - name: afterSeq
          in: query
          required: false
          schema: { type: integer, format: int64, minimum: 0 }
        - name: includeLogs
          in: query
          required: false
          description: Whether to include `job.log` events in the stream.
          schema: { type: boolean, default: true }
      responses:
        "200":
          description: OK
          content:
            text/event-stream:
              schema:
                type: string
        "401":
          $ref: "#/components/responses/ErrorResponse"
        "403":
          $ref: "#/components/responses/ErrorResponse"

  /meta:
    get:
      tags: [System]
      summary: Server metadata
      parameters:
        - $ref: "#/components/parameters/XApiToken"
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/MetaResponse"
        "401":
          $ref: "#/components/responses/ErrorResponse"
        "403":
          $ref: "#/components/responses/ErrorResponse"

  /profiles:
    get:
      tags: [Profiles]
      summary: List profiles
      parameters:
        - $ref: "#/components/parameters/XApiToken"
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/Profile"
    post:
      tags: [Profiles]
      summary: Create profile
      parameters:
        - $ref: "#/components/parameters/XApiToken"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/ProfileCreateRequest"
      responses:
        "201":
          description: Created
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Profile"
        "400":
          $ref: "#/components/responses/ErrorResponse"

  /profiles/{profileId}:
    patch:
      tags: [Profiles]
      summary: Update profile
      parameters:
        - $ref: "#/components/parameters/XApiToken"
        - $ref: "#/components/parameters/ProfileId"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/ProfileUpdateRequest"
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Profile"
        "400":
          $ref: "#/components/responses/ErrorResponse"
        "404":
          $ref: "#/components/responses/ErrorResponse"
    delete:
      tags: [Profiles]
      summary: Delete profile
      parameters:
        - $ref: "#/components/parameters/XApiToken"
        - $ref: "#/components/parameters/ProfileId"
      responses:
        "204":
          description: No Content
        "404":
          $ref: "#/components/responses/ErrorResponse"

  /profiles/{profileId}/test:
    post:
      tags: [Profiles]
      summary: Test connectivity/credentials for a profile
      parameters:
        - $ref: "#/components/parameters/XApiToken"
        - $ref: "#/components/parameters/ProfileId"
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ProfileTestResponse"
        "400":
          $ref: "#/components/responses/ErrorResponse"

        "404":
          $ref: "#/components/responses/ErrorResponse"

  /profiles/{profileId}/export:
    get:
      tags: [Profiles]
      summary: Export profile settings as YAML
      parameters:
        - $ref: "#/components/parameters/XApiToken"
        - $ref: "#/components/parameters/ProfileId"
        - name: download
          in: query
          description: When true, send Content-Disposition for file download.
          schema: { type: boolean, default: false }
      responses:
        "200":
          description: OK
          content:
            application/yaml:
              schema:
                type: string
        "400":
          $ref: "#/components/responses/ErrorResponse"
        "404":
          $ref: "#/components/responses/ErrorResponse"

  /profiles/{profileId}/tls:
    get:
      tags: [Profiles]
      summary: Get TLS configuration status
      parameters:
        - $ref: "#/components/parameters/XApiToken"
        - $ref: "#/components/parameters/ProfileId"
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ProfileTLSStatus"
        "400":
          $ref: "#/components/responses/ErrorResponse"
        "404":
          $ref: "#/components/responses/ErrorResponse"
    put:
      tags: [Profiles]
      summary: Set TLS configuration
      parameters:
        - $ref: "#/components/parameters/XApiToken"
        - $ref: "#/components/parameters/ProfileId"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/ProfileTLSConfig"
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ProfileTLSStatus"
        "400":
          $ref: "#/components/responses/ErrorResponse"
        "404":
          $ref: "#/components/responses/ErrorResponse"
    delete:
      tags: [Profiles]
      summary: Delete TLS configuration
      parameters:
        - $ref: "#/components/parameters/XApiToken"
        - $ref: "#/components/parameters/ProfileId"
      responses:
        "204":
          description: No Content
        "404":
          $ref: "#/components/responses/ErrorResponse"

  /buckets:
    get:
      tags: [Buckets]
      summary: List buckets
      parameters:
        - $ref: "#/components/parameters/XProfileId"
        - $ref: "#/components/parameters/XApiToken"
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/Bucket"
        "400":
          $ref: "#/components/responses/ErrorResponse"
    post:
      tags: [Buckets]
      summary: Create bucket
      parameters:
        - $ref: "#/components/parameters/XProfileId"
        - $ref: "#/components/parameters/XApiToken"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/BucketCreateRequest"
      responses:
        "201":
          description: Created
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Bucket"
        "400":
          $ref: "#/components/responses/ErrorResponse"

  /buckets/{bucket}:
    delete:
      tags: [Buckets]
      summary: Delete bucket
      description: |
        Deletes an empty bucket. If the bucket is not empty, the server returns `409 bucket_not_empty`.
      parameters:
        - $ref: "#/components/parameters/XProfileId"
        - $ref: "#/components/parameters/XApiToken"
        - $ref: "#/components/parameters/BucketName"
      responses:
        "204":
          description: No Content
        "404":
          $ref: "#/components/responses/ErrorResponse"
        "409":
          $ref: "#/components/responses/ErrorResponse"
        "400":
          $ref: "#/components/responses/ErrorResponse"

  /buckets/{bucket}/policy:
    get:
      tags: [Buckets]
      summary: Get bucket policy
      description: |
        Returns the current S3 bucket policy document if present.
        For buckets with no policy, returns `exists=false`.
      parameters:
        - $ref: "#/components/parameters/XProfileId"
        - $ref: "#/components/parameters/XApiToken"
        - $ref: "#/components/parameters/BucketName"
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/BucketPolicyResponse"
        "400":
          $ref: "#/components/responses/ErrorResponse"
        "404":
          $ref: "#/components/responses/ErrorResponse"
        "429":
          $ref: "#/components/responses/ErrorResponse"
        "502":
          $ref: "#/components/responses/ErrorResponse"
    put:
      tags: [Buckets]
      summary: Put bucket policy
      parameters:
        - $ref: "#/components/parameters/XProfileId"
        - $ref: "#/components/parameters/XApiToken"
        - $ref: "#/components/parameters/BucketName"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/BucketPolicyPutRequest"
      responses:
        "204":
          description: No Content
        "400":
          $ref: "#/components/responses/ErrorResponse"
        "404":
          $ref: "#/components/responses/ErrorResponse"
        "429":
          $ref: "#/components/responses/ErrorResponse"
        "502":
          $ref: "#/components/responses/ErrorResponse"
    delete:
      tags: [Buckets]
      summary: Delete bucket policy
      parameters:
        - $ref: "#/components/parameters/XProfileId"
        - $ref: "#/components/parameters/XApiToken"
        - $ref: "#/components/parameters/BucketName"
      responses:
        "204":
          description: No Content
        "400":
          $ref: "#/components/responses/ErrorResponse"
        "404":
          $ref: "#/components/responses/ErrorResponse"
        "429":
          $ref: "#/components/responses/ErrorResponse"
        "502":
          $ref: "#/components/responses/ErrorResponse"


  /buckets/{bucket}/policy/validate:
    post:
      tags: [Buckets]
      summary: Validate bucket policy
      description: |
        Performs static (non-mutating) validation of a provider-specific bucket access policy document.

        - For S3 providers, this is syntactic lint only. Real provider validation happens on PUT.
        - For GCS/Azure providers, this validates the expected JSON shape for IAM/ACL documents.
      parameters:
        - $ref: "#/components/parameters/XProfileId"
        - $ref: "#/components/parameters/XApiToken"
        - $ref: "#/components/parameters/BucketName"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/BucketPolicyPutRequest"
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/BucketPolicyValidateResponse"
        "400":
          $ref: "#/components/responses/ErrorResponse"


  /buckets/{bucket}/objects:
    get:
      tags: [Objects]
      summary: List objects and common prefixes (folder-like browsing)
      parameters:
        - $ref: "#/components/parameters/XProfileId"
        - $ref: "#/components/parameters/XApiToken"
        - $ref: "#/components/parameters/BucketName"
        - name: prefix
          in: query
          schema: { type: string, default: "" }
        - name: delimiter
          in: query
          schema: { type: string, default: "/" }
        - name: maxKeys
          in: query
          schema: { type: integer, minimum: 1, maximum: 1000, default: 500 }
        - name: continuationToken
          in: query
          schema: { type: string }
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ListObjectsResponse"
        "400":
          $ref: "#/components/responses/ErrorResponse"
    delete:
      tags: [Objects]
      summary: Delete objects (batch)
      description: For large batches, prefer using a Job.
      parameters:
        - $ref: "#/components/parameters/XProfileId"
        - $ref: "#/components/parameters/XApiToken"
        - $ref: "#/components/parameters/BucketName"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/DeleteObjectsRequest"
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/DeleteObjectsResponse"
        "400":
          $ref: "#/components/responses/ErrorResponse"

  /buckets/{bucket}/objects/search:
    get:
      tags: [Objects]
      summary: Search objects (indexed)
      description: |
        Searches a locally stored index of object keys for the given bucket.
        If the index has not been created yet, the server returns `409 not_indexed`.
        Create the index using the `s3_index_objects` job type.
      parameters:
        - $ref: "#/components/parameters/XProfileId"
        - $ref: "#/components/parameters/XApiToken"
        - $ref: "#/components/parameters/BucketName"
        - name: q
          in: query
          required: true
          schema: { type: string, minLength: 1 }
        - name: prefix
          in: query
          required: false
          schema: { type: string, default: "" }
        - name: limit
          in: query
          required: false
          schema: { type: integer, minimum: 1, maximum: 200, default: 50 }
        - name: cursor
          in: query
          required: false
          schema: { type: string }
        - name: ext
          in: query
          required: false
          schema: { type: string, description: "File extension filter (without dot)" }
        - name: minSize
          in: query
          required: false
          schema: { type: integer, format: int64, minimum: 0 }
        - name: maxSize
          in: query
          required: false
          schema: { type: integer, format: int64, minimum: 0 }
        - name: modifiedAfter
          in: query
          required: false
          schema: { type: string, format: date-time }
        - name: modifiedBefore
          in: query
          required: false
          schema: { type: string, format: date-time }
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/SearchObjectsResponse"
        "400":
          $ref: "#/components/responses/ErrorResponse"
        "409":
          $ref: "#/components/responses/ErrorResponse"

  /buckets/{bucket}/objects/index-summary:
    get:
      tags: [Objects]
      summary: Get object index summary for a prefix
      description: |
        Returns an estimate of impact (count/bytes/sample) using the local object index.
        If the index has not been created yet, the server returns `409 not_indexed`.
      parameters:
        - $ref: "#/components/parameters/XProfileId"
        - $ref: "#/components/parameters/XApiToken"
        - $ref: "#/components/parameters/BucketName"
        - name: prefix
          in: query
          required: false
          schema: { type: string, default: "" }
        - name: sampleLimit
          in: query
          required: false
          schema: { type: integer, minimum: 0, maximum: 100, default: 10 }
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ObjectIndexSummaryResponse"
        "400":
          $ref: "#/components/responses/ErrorResponse"
        "409":
          $ref: "#/components/responses/ErrorResponse"

  /buckets/{bucket}/objects/meta:
    get:
      tags: [Objects]
      summary: Get object metadata (HEAD)
      parameters:
        - $ref: "#/components/parameters/XProfileId"
        - $ref: "#/components/parameters/XApiToken"
        - $ref: "#/components/parameters/BucketName"
        - name: key
          in: query
          required: true
          schema: { type: string, minLength: 1 }
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ObjectMeta"
        "400":
          $ref: "#/components/responses/ErrorResponse"
        "404":
          $ref: "#/components/responses/ErrorResponse"

  /buckets/{bucket}/objects/folder:
    post:
      tags: [Objects]
      summary: Create a folder (prefix marker)
      description: |
        Creates a zero-byte object whose key ends with `/` so the prefix shows up as a folder in list operations.
        If the object already exists, the server returns `409 already_exists`.
      parameters:
        - $ref: "#/components/parameters/XProfileId"
        - $ref: "#/components/parameters/XApiToken"
        - $ref: "#/components/parameters/BucketName"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CreateFolderRequest"
      responses:
        "201":
          description: Created
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/CreateFolderResponse"
        "400":
          $ref: "#/components/responses/ErrorResponse"
        "409":
          $ref: "#/components/responses/ErrorResponse"

  /buckets/{bucket}/objects/download:
    get:
      tags: [Objects]
      summary: Download an object (server proxy)
      description: |
        Streams an object through this server as an attachment download.
        Useful for same-origin downloads (progress/ETA in the UI) and to avoid S3 CORS configuration.
      parameters:
        - $ref: "#/components/parameters/XProfileId"
        - $ref: "#/components/parameters/XApiToken"
        - $ref: "#/components/parameters/BucketName"
        - name: key
          in: query
          required: true
          schema: { type: string, minLength: 1 }
      responses:
        "200":
          description: OK
          content:
            application/octet-stream:
              schema:
                type: string
                format: binary
        "400":
          $ref: "#/components/responses/ErrorResponse"
        "404":
          $ref: "#/components/responses/ErrorResponse"

  /buckets/{bucket}/objects/download-url:
    get:
      tags: [Objects]
      summary: Get a presigned download URL (GET object)
      description: |
        Returns a download URL for an object.

        By default this uses `rclone link`, which may return a direct (backend) URL.
        If `proxy=true`, the server returns a signed proxy URL that enforces
        `Content-Disposition` and streams through the backend.
      parameters:
        - $ref: "#/components/parameters/XProfileId"
        - $ref: "#/components/parameters/XApiToken"
        - $ref: "#/components/parameters/BucketName"
        - name: key
          in: query
          required: true
          schema: { type: string, minLength: 1 }
        - name: expiresSeconds
          in: query
          required: false
          schema: { type: integer, minimum: 60, maximum: 3600, default: 900 }
        - name: proxy
          in: query
          required: false
          schema: { type: boolean, default: false }
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/PresignedURLResponse"
        "400":
          $ref: "#/components/responses/ErrorResponse"

  /download-proxy:
    get:
      tags: [Objects]
      summary: Download object via signed proxy URL
      description: |
        Signed URL returned from `/buckets/{bucket}/objects/download-url?proxy=true`.
        This endpoint does not require an API token but validates signature + expiry.
      servers:
        - url: http://127.0.0.1:8080
          description: Default local server (no /api/v1 prefix)
      parameters:
        - name: profileId
          in: query
          required: true
          schema: { type: string }
        - name: bucket
          in: query
          required: true
          schema: { type: string }
        - name: key
          in: query
          required: true
          schema: { type: string }
        - name: expires
          in: query
          required: true
          schema: { type: integer, format: int64 }
        - name: sig
          in: query
          required: true
          schema: { type: string }
      responses:
        "200":
          description: OK
          content:
            application/octet-stream:
              schema:
                type: string
                format: binary
        "400":
          $ref: "#/components/responses/ErrorResponse"
        "403":
          $ref: "#/components/responses/ErrorResponse"
        "404":
          $ref: "#/components/responses/ErrorResponse"

  /buckets/{bucket}/objects/favorites:
    get:
      tags: [Objects]
      summary: List favorite objects
      parameters:
        - $ref: "#/components/parameters/XProfileId"
        - $ref: "#/components/parameters/XApiToken"
        - $ref: "#/components/parameters/BucketName"
        - name: prefix
          in: query
          required: false
          schema: { type: string }
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ObjectFavoritesResponse"
        "400":
          $ref: "#/components/responses/ErrorResponse"
    post:
      tags: [Objects]
      summary: Add an object favorite
      parameters:
        - $ref: "#/components/parameters/XProfileId"
        - $ref: "#/components/parameters/XApiToken"
        - $ref: "#/components/parameters/BucketName"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/ObjectFavoriteCreateRequest"
      responses:
        "201":
          description: Created
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ObjectFavorite"
        "400":
          $ref: "#/components/responses/ErrorResponse"
    delete:
      tags: [Objects]
      summary: Remove an object favorite
      parameters:
        - $ref: "#/components/parameters/XProfileId"
        - $ref: "#/components/parameters/XApiToken"
        - $ref: "#/components/parameters/BucketName"
        - name: key
          in: query
          required: true
          schema: { type: string, minLength: 1 }
      responses:
        "204":
          description: No Content
        "400":
          $ref: "#/components/responses/ErrorResponse"

  /buckets/{bucket}/objects/thumbnail:
    get:
      tags: [Objects]
      summary: Get an image thumbnail
      parameters:
        - $ref: "#/components/parameters/XProfileId"
        - $ref: "#/components/parameters/XApiToken"
        - $ref: "#/components/parameters/BucketName"
        - name: key
          in: query
          required: true
          schema: { type: string, minLength: 1 }
        - name: size
          in: query
          required: false
          schema: { type: integer, minimum: 24, maximum: 512, default: 96 }
      responses:
        "200":
          description: OK
          content:
            image/jpeg:
              schema:
                type: string
                format: binary
        "400":
          $ref: "#/components/responses/ErrorResponse"
        "404":
          $ref: "#/components/responses/ErrorResponse"
        "413":
          $ref: "#/components/responses/ErrorResponse"
        "415":
          $ref: "#/components/responses/ErrorResponse"

  /uploads:
    post:
      tags: [Uploads]
      summary: Create a staging upload session
      parameters:
        - $ref: "#/components/parameters/XProfileId"
        - $ref: "#/components/parameters/XApiToken"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/UploadCreateRequest"
      responses:
        "201":
          description: Created
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/UploadCreateResponse"
        "400":
          $ref: "#/components/responses/ErrorResponse"

  /uploads/{uploadId}/files:
    post:
      tags: [Uploads]
      summary: Upload files to staging (multipart/form-data)
      parameters:
        - $ref: "#/components/parameters/XProfileId"
        - $ref: "#/components/parameters/XApiToken"
        - $ref: "#/components/parameters/UploadId"
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              properties:
                files:
                  type: array
                  items:
                    type: string
                    format: binary
      responses:
        "204":
          description: No Content
        "400":
          $ref: "#/components/responses/ErrorResponse"
        "413":
          $ref: "#/components/responses/ErrorResponse"
        "404":
          $ref: "#/components/responses/ErrorResponse"

  /uploads/{uploadId}/commit:
    post:
      tags: [Uploads]
      summary: Commit staged files to S3 (creates a Job)
      parameters:
        - $ref: "#/components/parameters/XProfileId"
        - $ref: "#/components/parameters/XApiToken"
        - $ref: "#/components/parameters/UploadId"
      requestBody:
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/UploadCommitRequest"
      responses:
        "201":
          description: Job created
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/JobCreatedResponse"
        "400":
          $ref: "#/components/responses/ErrorResponse"
        "404":
          $ref: "#/components/responses/ErrorResponse"

  /uploads/{uploadId}:
    delete:
      tags: [Uploads]
      summary: Cancel upload session and cleanup staging
      parameters:
        - $ref: "#/components/parameters/XProfileId"
        - $ref: "#/components/parameters/XApiToken"
        - $ref: "#/components/parameters/UploadId"
      responses:
        "204":
          description: No Content
        "404":
          $ref: "#/components/responses/ErrorResponse"

  /jobs:
    get:
      tags: [Jobs]
      summary: List jobs
      parameters:
        - $ref: "#/components/parameters/XProfileId"
        - $ref: "#/components/parameters/XApiToken"
        - name: status
          in: query
          schema: { $ref: "#/components/schemas/JobStatus" }
        - name: type
          in: query
          schema: { type: string }
        - name: limit
          in: query
          schema: { type: integer, minimum: 1, maximum: 200, default: 50 }
        - name: cursor
          in: query
          schema: { type: string }
        - name: errorCode
          in: query
          schema: { type: string }
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/JobsListResponse"
        "400":
          $ref: "#/components/responses/ErrorResponse"
    post:
      tags: [Jobs]
      summary: Create job (bulk transfer/sync/etc.)
      parameters:
        - $ref: "#/components/parameters/XProfileId"
        - $ref: "#/components/parameters/XApiToken"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/JobCreateRequest"
      responses:
        "201":
          description: Created
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Job"
        "400":
          $ref: "#/components/responses/ErrorResponse"

  /jobs/{jobId}:
    get:
      tags: [Jobs]
      summary: Get job
      parameters:
        - $ref: "#/components/parameters/XProfileId"
        - $ref: "#/components/parameters/XApiToken"
        - $ref: "#/components/parameters/JobId"
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Job"
        "404":
          $ref: "#/components/responses/ErrorResponse"
    delete:
      tags: [Jobs]
      summary: Delete job record (and its log file)
      description: Only allowed for non-active jobs (succeeded/failed/canceled). Cancel queued/running jobs first.
      parameters:
        - $ref: "#/components/parameters/XProfileId"
        - $ref: "#/components/parameters/XApiToken"
        - $ref: "#/components/parameters/JobId"
      responses:
        "204":
          description: No Content
        "404":
          $ref: "#/components/responses/ErrorResponse"
        "409":
          $ref: "#/components/responses/ErrorResponse"

  /jobs/{jobId}/artifact:
    get:
      tags: [Jobs]
      summary: Download job artifact (zip)
      parameters:
        - $ref: "#/components/parameters/XProfileId"
        - $ref: "#/components/parameters/XApiToken"
        - $ref: "#/components/parameters/JobId"
      responses:
        "200":
          description: OK
          content:
            application/zip:
              schema:
                type: string
                format: binary
        "404":
          $ref: "#/components/responses/ErrorResponse"
        "409":
          $ref: "#/components/responses/ErrorResponse"

  /jobs/{jobId}/logs:
    get:
      tags: [Jobs]
      summary: Get job logs (tail or incremental)
      parameters:
        - $ref: "#/components/parameters/XProfileId"
        - $ref: "#/components/parameters/XApiToken"
        - $ref: "#/components/parameters/JobId"
        - name: afterOffset
          in: query
          required: false
          description: |
            If set, reads the log file starting from this byte offset (0-based) and returns up to `maxBytes`.
            Response header `X-Log-Next-Offset` can be used as the next `afterOffset` value.
          schema: { type: integer, format: int64, minimum: 0 }
        - name: maxBytes
          in: query
          required: false
          description: Maximum number of bytes to read when using `afterOffset`.
          schema: { type: integer, minimum: 1, maximum: 1048576, default: 65536 }
        - name: tailBytes
          in: query
          required: false
          description: Number of bytes to read from the end of the log file.
          schema: { type: integer, minimum: 1, maximum: 1048576, default: 65536 }
      responses:
        "200":
          description: OK
          headers:
            X-Log-Next-Offset:
              description: Next byte offset to use as `afterOffset`.
              schema: { type: integer, format: int64 }
          content:
            text/plain:
              schema: { type: string }
        "400":
          $ref: "#/components/responses/ErrorResponse"
        "404":
          $ref: "#/components/responses/ErrorResponse"

  /jobs/{jobId}/retry:
    post:
      tags: [Jobs]
      summary: Retry job (creates a new queued job)
      parameters:
        - $ref: "#/components/parameters/XProfileId"
        - $ref: "#/components/parameters/XApiToken"
        - $ref: "#/components/parameters/JobId"
      responses:
        "201":
          description: Created
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Job"
        "400":
          $ref: "#/components/responses/ErrorResponse"
        "404":
          $ref: "#/components/responses/ErrorResponse"

  /jobs/{jobId}/cancel:
    post:
      tags: [Jobs]
      summary: Cancel job
      parameters:
        - $ref: "#/components/parameters/XProfileId"
        - $ref: "#/components/parameters/XApiToken"
        - $ref: "#/components/parameters/JobId"
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Job"
        "404":
          $ref: "#/components/responses/ErrorResponse"

  /local/entries:
    get:
      tags: [Local]
      summary: List local directory entries (allowed roots only)
      description: |
        Lists directories under `ALLOWED_LOCAL_DIRS` for safe local-path selection.
        If `path` is omitted, returns the allowed roots.
        If `ALLOWED_LOCAL_DIRS` is not configured, the server returns `400 not_configured`.
      parameters:
        - $ref: "#/components/parameters/XProfileId"
        - $ref: "#/components/parameters/XApiToken"
        - name: path
          in: query
          required: false
          schema: { type: string }
        - name: limit
          in: query
          required: false
          schema: { type: integer, minimum: 1, maximum: 5000, default: 2000 }
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ListLocalEntriesResponse"
        "400":
          $ref: "#/components/responses/ErrorResponse"
        "403":
          $ref: "#/components/responses/ErrorResponse"
        "404":
          $ref: "#/components/responses/ErrorResponse"

components:
  parameters:
    XProfileId:
      name: X-Profile-Id
      in: header
      required: true
      schema: { type: string, minLength: 1 }
    XApiToken:
      name: X-Api-Token
      in: header
      required: false
      description: Optional local API token to mitigate localhost/CSRF style attacks.
      schema: { type: string }
    ProfileId:
      name: profileId
      in: path
      required: true
      schema: { type: string, minLength: 1 }
    BucketName:
      name: bucket
      in: path
      required: true
      schema: { type: string, minLength: 3 }
    UploadId:
      name: uploadId
      in: path
      required: true
      schema: { type: string, minLength: 1 }
    JobId:
      name: jobId
      in: path
      required: true
      schema: { type: string, minLength: 1 }

  responses:
    ErrorResponse:
      description: Error
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorResponse"

  schemas:
    ErrorResponse:
      type: object
      required: [error]
      properties:
        error:
          type: object
          required: [code, message]
          properties:
            code: { type: string }
            message: { type: string }
            normalizedError:
              $ref: "#/components/schemas/NormalizedError"
            details: { type: object, additionalProperties: true }

    NormalizedError:
      type: object
      description: Provider-agnostic error classifier (primarily derived from rclone stderr).
      required: [code, retryable]
      properties:
        code:
          $ref: "#/components/schemas/NormalizedErrorCode"
        retryable:
          type: boolean

    NormalizedErrorCode:
      type: string
      enum:
        - invalid_credentials
        - access_denied
        - not_found
        - rate_limited
        - network_error
        - invalid_config
        - signature_mismatch
        - request_time_skewed
        - conflict
        - upstream_timeout
        - endpoint_unreachable
        - canceled
        - unknown

    ProfileProvider:
      type: string
      description: Storage provider backend for a profile.
      enum: [aws_s3, s3_compatible, oci_s3_compat, azure_blob, gcp_gcs, oci_object_storage]

    ProfileBase:
      type: object
      required: [id, name, provider, preserveLeadingSlash, tlsInsecureSkipVerify, createdAt, updatedAt]
      properties:
        id: { type: string }
        name: { type: string }
        provider:
          $ref: "#/components/schemas/ProfileProvider"
        preserveLeadingSlash: { type: boolean }
        tlsInsecureSkipVerify: { type: boolean }
        createdAt: { type: string, format: date-time }
        updatedAt: { type: string, format: date-time }

    ProfileAwsS3:
      allOf:
        - $ref: "#/components/schemas/ProfileBase"
        - type: object
          required: [provider, region, forcePathStyle]
          properties:
            provider: { type: string, enum: [aws_s3] }
            endpoint:
              type: string
              description: Optional. If omitted, uses AWS default endpoint resolution.
            region: { type: string }
            forcePathStyle: { type: boolean }

    ProfileS3Compatible:
      allOf:
        - $ref: "#/components/schemas/ProfileBase"
        - type: object
          required: [provider, endpoint, region, forcePathStyle]
          properties:
            provider: { type: string, enum: [s3_compatible] }
            endpoint: { type: string }
            region: { type: string }
            forcePathStyle: { type: boolean }

    ProfileOciS3Compat:
      allOf:
        - $ref: "#/components/schemas/ProfileBase"
        - type: object
          required: [provider, endpoint, region, forcePathStyle]
          properties:
            provider: { type: string, enum: [oci_s3_compat] }
            endpoint: { type: string }
            region: { type: string }
            forcePathStyle: { type: boolean }

    ProfileAzureBlob:
      allOf:
        - $ref: "#/components/schemas/ProfileBase"
        - type: object
          required: [provider, accountName]
          properties:
            provider: { type: string, enum: [azure_blob] }
            accountName: { type: string }
            endpoint:
              type: string
              description: Optional. Used for local emulators (Azurite) or custom Azure endpoints.
            useEmulator:
              type: boolean
              description: Optional. If true and endpoint is omitted, server may choose a default emulator endpoint.

    ProfileGcpGcs:
      allOf:
        - $ref: "#/components/schemas/ProfileBase"
        - type: object
          required: [provider]
          properties:
            provider: { type: string, enum: [gcp_gcs] }
            projectId: { type: string }
            clientEmail: { type: string }
            endpoint:
              type: string
              description: Optional. Used for local emulators (fake-gcs-server) or custom endpoints.
            anonymous:
              type: boolean
              description: Optional. If true, requests are unauthenticated and serviceAccountJson can be omitted.
            projectNumber: { type: string }

    ProfileOciObjectStorage:
      allOf:
        - $ref: "#/components/schemas/ProfileBase"
        - type: object
          required: [provider, region, namespace, compartment]
          properties:
            provider: { type: string, enum: [oci_object_storage] }
            region: { type: string }
            namespace: { type: string }
            compartment: { type: string }
            endpoint: { type: string }
            authProvider: { type: string }
            configFile: { type: string }
            configProfile: { type: string }

    Profile:
      oneOf:
        - $ref: "#/components/schemas/ProfileAwsS3"
        - $ref: "#/components/schemas/ProfileS3Compatible"
        - $ref: "#/components/schemas/ProfileOciS3Compat"
        - $ref: "#/components/schemas/ProfileAzureBlob"
        - $ref: "#/components/schemas/ProfileGcpGcs"
        - $ref: "#/components/schemas/ProfileOciObjectStorage"
      discriminator:
        propertyName: provider
        mapping:
          aws_s3: "#/components/schemas/ProfileAwsS3"
          s3_compatible: "#/components/schemas/ProfileS3Compatible"
          oci_s3_compat: "#/components/schemas/ProfileOciS3Compat"
          azure_blob: "#/components/schemas/ProfileAzureBlob"
          gcp_gcs: "#/components/schemas/ProfileGcpGcs"
          oci_object_storage: "#/components/schemas/ProfileOciObjectStorage"

    ProfileCreateRequestAwsS3:
      type: object
      additionalProperties: false
      required: [provider, name, region, accessKeyId, secretAccessKey, forcePathStyle, preserveLeadingSlash, tlsInsecureSkipVerify]
      properties:
        provider: { type: string, enum: [aws_s3] }
        name: { type: string }
        endpoint:
          type: string
          description: Optional. If omitted, uses AWS default endpoint resolution.
        region: { type: string }
        accessKeyId: { type: string }
        secretAccessKey: { type: string }
        sessionToken: { type: string, nullable: true }
        forcePathStyle: { type: boolean, default: false }
        preserveLeadingSlash: { type: boolean, default: false }
        tlsInsecureSkipVerify: { type: boolean, default: false }

    ProfileCreateRequestS3Compatible:
      type: object
      additionalProperties: false
      required: [provider, name, endpoint, region, accessKeyId, secretAccessKey, forcePathStyle, preserveLeadingSlash, tlsInsecureSkipVerify]
      properties:
        provider: { type: string, enum: [s3_compatible] }
        name: { type: string }
        endpoint: { type: string }
        region: { type: string }
        accessKeyId: { type: string }
        secretAccessKey: { type: string }
        sessionToken: { type: string, nullable: true }
        forcePathStyle: { type: boolean, default: false }
        preserveLeadingSlash: { type: boolean, default: false }
        tlsInsecureSkipVerify: { type: boolean, default: false }

    ProfileCreateRequestOciS3Compat:
      type: object
      additionalProperties: false
      required: [provider, name, endpoint, region, accessKeyId, secretAccessKey, forcePathStyle, preserveLeadingSlash, tlsInsecureSkipVerify]
      properties:
        provider: { type: string, enum: [oci_s3_compat] }
        name: { type: string }
        endpoint: { type: string }
        region: { type: string }
        accessKeyId: { type: string }
        secretAccessKey: { type: string }
        sessionToken: { type: string, nullable: true }
        forcePathStyle: { type: boolean, default: false }
        preserveLeadingSlash: { type: boolean, default: false }
        tlsInsecureSkipVerify: { type: boolean, default: false }

    ProfileCreateRequestAzureBlob:
      type: object
      additionalProperties: false
      required: [provider, name, accountName, accountKey, preserveLeadingSlash, tlsInsecureSkipVerify]
      properties:
        provider: { type: string, enum: [azure_blob] }
        name: { type: string }
        accountName: { type: string }
        accountKey: { type: string }
        endpoint:
          type: string
          description: Optional. Used for local emulators (Azurite) or custom Azure endpoints.
        useEmulator:
          type: boolean
          description: Optional. If true and endpoint is omitted, server may choose a default emulator endpoint.
        preserveLeadingSlash: { type: boolean, default: false }
        tlsInsecureSkipVerify: { type: boolean, default: false }

    ProfileCreateRequestGcpGcs:
      type: object
      additionalProperties: false
      required: [provider, name, preserveLeadingSlash, tlsInsecureSkipVerify]
      properties:
        provider: { type: string, enum: [gcp_gcs] }
        name: { type: string }
        serviceAccountJson:
          type: string
          description: GCP service account JSON. Required unless anonymous=true.
        anonymous:
          type: boolean
          description: If true, requests are unauthenticated and serviceAccountJson can be omitted.
        endpoint:
          type: string
          description: Optional. Used for local emulators (fake-gcs-server) or custom endpoints.
        projectNumber: { type: string }
        preserveLeadingSlash: { type: boolean, default: false }
        tlsInsecureSkipVerify: { type: boolean, default: false }

    ProfileCreateRequestOciObjectStorage:
      type: object
      additionalProperties: false
      required: [provider, name, region, namespace, compartment, preserveLeadingSlash, tlsInsecureSkipVerify]
      properties:
        provider: { type: string, enum: [oci_object_storage] }
        name: { type: string }
        region: { type: string }
        namespace: { type: string }
        compartment: { type: string }
        endpoint: { type: string }
        authProvider: { type: string }
        configFile: { type: string }
        configProfile: { type: string }
        preserveLeadingSlash: { type: boolean, default: false }
        tlsInsecureSkipVerify: { type: boolean, default: false }

    ProfileCreateRequest:
      oneOf:
        - $ref: "#/components/schemas/ProfileCreateRequestAwsS3"
        - $ref: "#/components/schemas/ProfileCreateRequestS3Compatible"
        - $ref: "#/components/schemas/ProfileCreateRequestOciS3Compat"
        - $ref: "#/components/schemas/ProfileCreateRequestAzureBlob"
        - $ref: "#/components/schemas/ProfileCreateRequestGcpGcs"
        - $ref: "#/components/schemas/ProfileCreateRequestOciObjectStorage"
      discriminator:
        propertyName: provider
        mapping:
          aws_s3: "#/components/schemas/ProfileCreateRequestAwsS3"
          s3_compatible: "#/components/schemas/ProfileCreateRequestS3Compatible"
          oci_s3_compat: "#/components/schemas/ProfileCreateRequestOciS3Compat"
          azure_blob: "#/components/schemas/ProfileCreateRequestAzureBlob"
          gcp_gcs: "#/components/schemas/ProfileCreateRequestGcpGcs"
          oci_object_storage: "#/components/schemas/ProfileCreateRequestOciObjectStorage"

    ProfileUpdateRequestAwsS3:
      type: object
      additionalProperties: false
      required: [provider]
      properties:
        provider: { type: string, enum: [aws_s3] }
        name: { type: string }
        endpoint: { type: string }
        region: { type: string }
        accessKeyId: { type: string }
        secretAccessKey: { type: string }
        sessionToken:
          type: string
          nullable: true
          description: Set to empty string to clear; omit to keep unchanged.
        forcePathStyle: { type: boolean }
        preserveLeadingSlash: { type: boolean }
        tlsInsecureSkipVerify: { type: boolean }

    ProfileUpdateRequestS3Compatible:
      type: object
      additionalProperties: false
      required: [provider]
      properties:
        provider: { type: string, enum: [s3_compatible] }
        name: { type: string }
        endpoint: { type: string }
        region: { type: string }
        accessKeyId: { type: string }
        secretAccessKey: { type: string }
        sessionToken:
          type: string
          nullable: true
          description: Set to empty string to clear; omit to keep unchanged.
        forcePathStyle: { type: boolean }
        preserveLeadingSlash: { type: boolean }
        tlsInsecureSkipVerify: { type: boolean }

    ProfileUpdateRequestOciS3Compat:
      type: object
      additionalProperties: false
      required: [provider]
      properties:
        provider: { type: string, enum: [oci_s3_compat] }
        name: { type: string }
        endpoint: { type: string }
        region: { type: string }
        accessKeyId: { type: string }
        secretAccessKey: { type: string }
        sessionToken:
          type: string
          nullable: true
          description: Set to empty string to clear; omit to keep unchanged.
        forcePathStyle: { type: boolean }
        preserveLeadingSlash: { type: boolean }
        tlsInsecureSkipVerify: { type: boolean }

    ProfileUpdateRequestAzureBlob:
      type: object
      additionalProperties: false
      required: [provider]
      properties:
        provider: { type: string, enum: [azure_blob] }
        name: { type: string }
        accountName: { type: string }
        accountKey: { type: string }
        endpoint:
          type: string
          description: Optional. Used for local emulators (Azurite) or custom Azure endpoints.
        useEmulator:
          type: boolean
          description: Optional. If true and endpoint is omitted, server may choose a default emulator endpoint.
        preserveLeadingSlash: { type: boolean }
        tlsInsecureSkipVerify: { type: boolean }

    ProfileUpdateRequestGcpGcs:
      type: object
      additionalProperties: false
      required: [provider]
      properties:
        provider: { type: string, enum: [gcp_gcs] }
        name: { type: string }
        serviceAccountJson: { type: string }
        anonymous:
          type: boolean
          description: If true, requests are unauthenticated and serviceAccountJson can be omitted.
        endpoint:
          type: string
          description: Optional. Used for local emulators (fake-gcs-server) or custom endpoints.
        projectNumber: { type: string }
        preserveLeadingSlash: { type: boolean }
        tlsInsecureSkipVerify: { type: boolean }

    ProfileUpdateRequestOciObjectStorage:
      type: object
      additionalProperties: false
      required: [provider]
      properties:
        provider: { type: string, enum: [oci_object_storage] }
        name: { type: string }
        region: { type: string }
        namespace: { type: string }
        compartment: { type: string }
        endpoint: { type: string }
        authProvider: { type: string }
        configFile: { type: string }
        configProfile: { type: string }
        preserveLeadingSlash: { type: boolean }
        tlsInsecureSkipVerify: { type: boolean }

    ProfileUpdateRequest:
      oneOf:
        - $ref: "#/components/schemas/ProfileUpdateRequestAwsS3"
        - $ref: "#/components/schemas/ProfileUpdateRequestS3Compatible"
        - $ref: "#/components/schemas/ProfileUpdateRequestOciS3Compat"
        - $ref: "#/components/schemas/ProfileUpdateRequestAzureBlob"
        - $ref: "#/components/schemas/ProfileUpdateRequestGcpGcs"
        - $ref: "#/components/schemas/ProfileUpdateRequestOciObjectStorage"
      discriminator:
        propertyName: provider
        mapping:
          aws_s3: "#/components/schemas/ProfileUpdateRequestAwsS3"
          s3_compatible: "#/components/schemas/ProfileUpdateRequestS3Compatible"
          oci_s3_compat: "#/components/schemas/ProfileUpdateRequestOciS3Compat"
          azure_blob: "#/components/schemas/ProfileUpdateRequestAzureBlob"
          gcp_gcs: "#/components/schemas/ProfileUpdateRequestGcpGcs"
          oci_object_storage: "#/components/schemas/ProfileUpdateRequestOciObjectStorage"

    ProfileTestResponse:
      type: object
      required: [ok]
      properties:
        ok: { type: boolean }
        message: { type: string }
        details:
          type: object
          additionalProperties: true
          description: |
            Additional test metadata.
            Known keys:
              - buckets: number of buckets returned by ListBuckets.
              - storageType: detected storage type (ceph, aws-s3, s3-compatible, unknown).
              - storageTypeSource: detection source (server-header, endpoint, default, none).
              - error: error string when ok=false.

    ProfileTLSMode:
      type: string
      enum: [disabled, mtls]

    ProfileTLSConfig:
      type: object
      additionalProperties: false
      required: [mode]
      properties:
        mode:
          $ref: "#/components/schemas/ProfileTLSMode"
        clientCertPem: { type: string }
        clientKeyPem: { type: string }
        caCertPem: { type: string }

    ProfileTLSStatus:
      type: object
      required: [mode, hasClientCert, hasClientKey, hasCa]
      properties:
        mode:
          $ref: "#/components/schemas/ProfileTLSMode"
        hasClientCert: { type: boolean }
        hasClientKey: { type: boolean }
        hasCa: { type: boolean }
        updatedAt: { type: string, format: date-time }

    Bucket:
      type: object
      required: [name]
      properties:
        name: { type: string }
        createdAt: { type: string, format: date-time }

    BucketCreateRequest:
      type: object
      additionalProperties: false
      required: [name]
      properties:
        name: { type: string }
        region: { type: string }

    BucketPolicyResponse:
      type: object
      required: [bucket, exists]
      properties:
        bucket: { type: string }
        exists: { type: boolean }
        policy:
          description: |
            Bucket access policy document.

            - S3 providers: S3 bucket policy JSON.
            - GCS: bucket IAM policy JSON (bindings).
            - Azure: container public access + stored access policy JSON.
          type: object
          nullable: true
          additionalProperties: true

    BucketPolicyPutRequest:
      type: object
      additionalProperties: false
      required: [policy]
      properties:
        policy:
          description: Bucket access policy document (provider-specific).
          type: object
          additionalProperties: true

    BucketPolicyValidateResponse:
      type: object
      required: [ok, provider]
      properties:
        ok: { type: boolean }
        provider:
          $ref: "#/components/schemas/ProfileProvider"
        errors:
          type: array
          items: { type: string }
        warnings:
          type: array
          items: { type: string }


    ObjectItem:
      type: object
      required: [key, size, lastModified]
      properties:
        key: { type: string }
        size: { type: integer, format: int64 }
        etag: { type: string }
        lastModified: { type: string, format: date-time }
        storageClass: { type: string }

    ObjectFavorite:
      type: object
      required: [key, createdAt]
      properties:
        key: { type: string }
        createdAt: { type: string, format: date-time }

    ObjectFavoriteCreateRequest:
      type: object
      additionalProperties: false
      required: [key]
      properties:
        key: { type: string }

    FavoriteObjectItem:
      allOf:
        - $ref: "#/components/schemas/ObjectItem"
        - type: object
          required: [createdAt]
          properties:
            createdAt: { type: string, format: date-time }

    ObjectFavoritesResponse:
      type: object
      required: [bucket, items]
      properties:
        bucket: { type: string }
        prefix: { type: string }
        items:
          type: array
          items: { $ref: "#/components/schemas/FavoriteObjectItem" }

    ListObjectsResponse:
      type: object
      required: [bucket, prefix, delimiter, commonPrefixes, items, isTruncated]
      properties:
        bucket: { type: string }
        prefix: { type: string }
        delimiter: { type: string }
        commonPrefixes:
          type: array
          items: { type: string }
        items:
          type: array
          items: { $ref: "#/components/schemas/ObjectItem" }
        nextContinuationToken: { type: string, nullable: true }
        isTruncated: { type: boolean }

    SearchObjectsResponse:
      type: object
      required: [bucket, query, items]
      properties:
        bucket: { type: string }
        query: { type: string }
        prefix: { type: string }
        items:
          type: array
          items: { $ref: "#/components/schemas/ObjectItem" }
        nextCursor: { type: string, nullable: true }

    ObjectIndexSummaryResponse:
      type: object
      required: [bucket, objectCount, totalBytes, sampleKeys]
      properties:
        bucket: { type: string }
        prefix: { type: string }
        objectCount: { type: integer, format: int64 }
        totalBytes: { type: integer, format: int64 }
        sampleKeys:
          type: array
          items: { type: string }
        indexedAt: { type: string, format: date-time, nullable: true }

    LocalEntry:
      type: object
      required: [name, path, isDir]
      properties:
        name: { type: string }
        path: { type: string }
        isDir: { type: boolean }

    ListLocalEntriesResponse:
      type: object
      required: [entries]
      properties:
        basePath: { type: string }
        entries:
          type: array
          items: { $ref: "#/components/schemas/LocalEntry" }

    ObjectMeta:
      type: object
      required: [key]
      properties:
        key: { type: string }
        size: { type: integer, format: int64 }
        etag: { type: string }
        lastModified: { type: string, format: date-time }
        contentType: { type: string }
        metadata:
          type: object
          additionalProperties: { type: string }

    PresignedURLResponse:
      type: object
      required: [url, expiresAt]
      properties:
        url: { type: string, format: uri }
        expiresAt: { type: string, format: date-time }

    CreateFolderRequest:
      type: object
      additionalProperties: false
      required: [key]
      properties:
        key: { type: string, minLength: 1, description: Object key ending with `/` }

    CreateFolderResponse:
      type: object
      additionalProperties: false
      required: [key]
      properties:
        key: { type: string }

    DeleteObjectsRequest:
      type: object
      additionalProperties: false
      required: [keys]
      properties:
        keys:
          type: array
          minItems: 1
          maxItems: 1000
          items: { type: string, minLength: 1 }

    DeleteObjectsResponse:
      type: object
      required: [deleted]
      properties:
        deleted:
          type: integer
          minimum: 0

    UploadCreateRequest:
      type: object
      additionalProperties: false
      required: [bucket]
      properties:
        bucket: { type: string }
        prefix: { type: string, default: "" }

    UploadCreateResponse:
      type: object
      required: [uploadId, expiresAt]
      properties:
        uploadId: { type: string }
        maxBytes: { type: integer, format: int64, nullable: true }
        expiresAt: { type: string, format: date-time }

    UploadCommitItem:
      type: object
      additionalProperties: false
      required: [path]
      properties:
        path: { type: string }
        size: { type: integer, format: int64 }

    UploadCommitRequest:
      type: object
      additionalProperties: false
      properties:
        label: { type: string }
        rootName: { type: string }
        rootKind: { type: string, enum: [file, folder, collection] }
        totalFiles: { type: integer }
        totalBytes: { type: integer, format: int64 }
        items:
          type: array
          items: { $ref: "#/components/schemas/UploadCommitItem" }
        itemsTruncated: { type: boolean }

    JobStatus:
      type: string
      enum: [queued, running, succeeded, failed, canceled]

    JobType:
      type: string
      description: Supported job types.
      enum:
        - transfer_sync_local_to_s3
        - transfer_sync_staging_to_s3
        - transfer_sync_s3_to_local
        - transfer_delete_prefix
        - s3_zip_prefix
        - s3_zip_objects
        - s3_delete_objects
        - s3_index_objects
        - transfer_copy_object
        - transfer_move_object
        - transfer_copy_batch
        - transfer_move_batch
        - transfer_copy_prefix
        - transfer_move_prefix

    TransferSyncLocalToS3Payload:
      type: object
      additionalProperties: false
      required: [bucket, localPath]
      properties:
        bucket: { type: string, minLength: 1 }
        prefix: { type: string, default: "" }
        localPath: { type: string, minLength: 1 }
        deleteExtraneous: { type: boolean, default: false }
        include:
          type: array
          items: { type: string }
        exclude:
          type: array
          items: { type: string }
        dryRun: { type: boolean, default: false }

    TransferSyncStagingToS3Payload:
      type: object
      additionalProperties: false
      required: [uploadId]
      properties:
        uploadId: { type: string, minLength: 1 }
        bucket: { type: string }
        prefix: { type: string }
        label: { type: string }
        rootName: { type: string }
        rootKind: { type: string, enum: [file, folder, collection] }
        totalFiles: { type: integer }
        totalBytes: { type: integer, format: int64 }
        items:
          type: array
          items: { $ref: "#/components/schemas/TransferSyncStagingToS3Item" }
        itemsTruncated: { type: boolean }

    TransferSyncStagingToS3Item:
      type: object
      additionalProperties: false
      required: [path, key]
      properties:
        path: { type: string }
        key: { type: string }
        size: { type: integer, format: int64 }

    TransferSyncS3ToLocalPayload:
      type: object
      additionalProperties: false
      required: [bucket, localPath]
      properties:
        bucket: { type: string, minLength: 1 }
        prefix: { type: string, default: "" }
        localPath: { type: string, minLength: 1, description: Local destination directory path }
        deleteExtraneous: { type: boolean, default: false, description: Delete local files that are not in S3 (sync mode). }
        include:
          type: array
          items: { type: string }
        exclude:
          type: array
          items: { type: string }
        dryRun: { type: boolean, default: false }

    TransferDeletePrefixPayload:
      type: object
      additionalProperties: false
      required: [bucket]
      description: |
        Either provide `prefix` (recommended to end with `/`) or set `deleteAll=true` to delete all objects in the bucket.
      properties:
        bucket: { type: string, minLength: 1 }
        prefix: { type: string, default: "" }
        deleteAll: { type: boolean, default: false }
        allowUnsafePrefix: { type: boolean, default: false }
        include:
          type: array
          items: { type: string }
        exclude:
          type: array
          items: { type: string }
        dryRun: { type: boolean, default: false }

    S3ZipPrefixPayload:
      type: object
      additionalProperties: false
      required: [bucket]
      properties:
        bucket: { type: string, minLength: 1 }
        prefix: { type: string, default: "", description: Prefix to zip (optional). }

    S3ZipObjectsPayload:
      type: object
      additionalProperties: false
      required: [bucket, keys]
      properties:
        bucket: { type: string, minLength: 1 }
        keys:
          type: array
          minItems: 1
          maxItems: 10000
          items: { type: string, minLength: 1 }
        stripPrefix:
          type: string
          default: ""
          description: If set, removes this prefix from object keys inside the zip.

    S3DeleteObjectsPayload:
      type: object
      additionalProperties: false
      required: [bucket, keys]
      properties:
        bucket: { type: string, minLength: 1 }
        keys:
          type: array
          minItems: 1
          maxItems: 50000
          items: { type: string, minLength: 1 }

    S3IndexObjectsPayload:
      type: object
      additionalProperties: false
      required: [bucket]
      properties:
        bucket: { type: string, minLength: 1 }
        prefix: { type: string, default: "" }
        fullReindex: { type: boolean, default: true, description: Clear existing index entries for this bucket/prefix before indexing. }

    TransferCopyObjectPayload:
      type: object
      additionalProperties: false
      required: [srcBucket, srcKey, dstBucket, dstKey]
      properties:
        srcBucket: { type: string, minLength: 1 }
        srcKey: { type: string, minLength: 1 }
        dstBucket: { type: string, minLength: 1 }
        dstKey: { type: string, minLength: 1 }
        dryRun: { type: boolean, default: false }

    TransferMoveObjectPayload:
      type: object
      additionalProperties: false
      required: [srcBucket, srcKey, dstBucket, dstKey]
      properties:
        srcBucket: { type: string, minLength: 1 }
        srcKey: { type: string, minLength: 1 }
        dstBucket: { type: string, minLength: 1 }
        dstKey: { type: string, minLength: 1 }
        dryRun: { type: boolean, default: false }

    TransferBatchItem:
      type: object
      additionalProperties: false
      required: [srcKey, dstKey]
      properties:
        srcKey: { type: string, minLength: 1 }
        dstKey: { type: string, minLength: 1 }

    TransferCopyBatchPayload:
      type: object
      additionalProperties: false
      required: [srcBucket, dstBucket, items]
      properties:
        srcBucket: { type: string, minLength: 1 }
        dstBucket: { type: string, minLength: 1 }
        items:
          type: array
          minItems: 1
          maxItems: 5000
          items: { $ref: "#/components/schemas/TransferBatchItem" }
        dryRun: { type: boolean, default: false }

    TransferMoveBatchPayload:
      type: object
      additionalProperties: false
      required: [srcBucket, dstBucket, items]
      properties:
        srcBucket: { type: string, minLength: 1 }
        dstBucket: { type: string, minLength: 1 }
        items:
          type: array
          minItems: 1
          maxItems: 5000
          items: { $ref: "#/components/schemas/TransferBatchItem" }
        dryRun: { type: boolean, default: false }

    TransferCopyPrefixPayload:
      type: object
      additionalProperties: false
      required: [srcBucket, srcPrefix, dstBucket]
      properties:
        srcBucket: { type: string, minLength: 1 }
        srcPrefix: { type: string, minLength: 1, description: Must end with `/` }
        dstBucket: { type: string, minLength: 1 }
        dstPrefix: { type: string, default: "" }
        include:
          type: array
          items: { type: string }
        exclude:
          type: array
          items: { type: string }
        dryRun: { type: boolean, default: false }

    TransferMovePrefixPayload:
      type: object
      additionalProperties: false
      required: [srcBucket, srcPrefix, dstBucket]
      properties:
        srcBucket: { type: string, minLength: 1 }
        srcPrefix: { type: string, minLength: 1, description: Must end with `/` }
        dstBucket: { type: string, minLength: 1 }
        dstPrefix: { type: string, default: "" }
        include:
          type: array
          items: { type: string }
        exclude:
          type: array
          items: { type: string }
        dryRun: { type: boolean, default: false }

    JobCreateRequestTransferSyncLocalToS3:
      type: object
      additionalProperties: false
      required: [type, payload]
      properties:
        type: { type: string, enum: [transfer_sync_local_to_s3] }
        payload: { $ref: "#/components/schemas/TransferSyncLocalToS3Payload" }

    JobCreateRequestTransferSyncStagingToS3:
      type: object
      additionalProperties: false
      required: [type, payload]
      properties:
        type: { type: string, enum: [transfer_sync_staging_to_s3] }
        payload: { $ref: "#/components/schemas/TransferSyncStagingToS3Payload" }

    JobCreateRequestTransferSyncS3ToLocal:
      type: object
      additionalProperties: false
      required: [type, payload]
      properties:
        type: { type: string, enum: [transfer_sync_s3_to_local] }
        payload: { $ref: "#/components/schemas/TransferSyncS3ToLocalPayload" }

    JobCreateRequestTransferDeletePrefix:
      type: object
      additionalProperties: false
      required: [type, payload]
      properties:
        type: { type: string, enum: [transfer_delete_prefix] }
        payload: { $ref: "#/components/schemas/TransferDeletePrefixPayload" }

    JobCreateRequestS3ZipPrefix:
      type: object
      additionalProperties: false
      required: [type, payload]
      properties:
        type: { type: string, enum: [s3_zip_prefix] }
        payload: { $ref: "#/components/schemas/S3ZipPrefixPayload" }

    JobCreateRequestS3ZipObjects:
      type: object
      additionalProperties: false
      required: [type, payload]
      properties:
        type: { type: string, enum: [s3_zip_objects] }
        payload: { $ref: "#/components/schemas/S3ZipObjectsPayload" }

    JobCreateRequestS3DeleteObjects:
      type: object
      additionalProperties: false
      required: [type, payload]
      properties:
        type: { type: string, enum: [s3_delete_objects] }
        payload: { $ref: "#/components/schemas/S3DeleteObjectsPayload" }

    JobCreateRequestS3IndexObjects:
      type: object
      additionalProperties: false
      required: [type, payload]
      properties:
        type: { type: string, enum: [s3_index_objects] }
        payload: { $ref: "#/components/schemas/S3IndexObjectsPayload" }

    JobCreateRequestTransferCopyObject:
      type: object
      additionalProperties: false
      required: [type, payload]
      properties:
        type: { type: string, enum: [transfer_copy_object] }
        payload: { $ref: "#/components/schemas/TransferCopyObjectPayload" }

    JobCreateRequestTransferMoveObject:
      type: object
      additionalProperties: false
      required: [type, payload]
      properties:
        type: { type: string, enum: [transfer_move_object] }
        payload: { $ref: "#/components/schemas/TransferMoveObjectPayload" }

    JobCreateRequestTransferCopyBatch:
      type: object
      additionalProperties: false
      required: [type, payload]
      properties:
        type: { type: string, enum: [transfer_copy_batch] }
        payload: { $ref: "#/components/schemas/TransferCopyBatchPayload" }

    JobCreateRequestTransferMoveBatch:
      type: object
      additionalProperties: false
      required: [type, payload]
      properties:
        type: { type: string, enum: [transfer_move_batch] }
        payload: { $ref: "#/components/schemas/TransferMoveBatchPayload" }

    JobCreateRequestTransferCopyPrefix:
      type: object
      additionalProperties: false
      required: [type, payload]
      properties:
        type: { type: string, enum: [transfer_copy_prefix] }
        payload: { $ref: "#/components/schemas/TransferCopyPrefixPayload" }

    JobCreateRequestTransferMovePrefix:
      type: object
      additionalProperties: false
      required: [type, payload]
      properties:
        type: { type: string, enum: [transfer_move_prefix] }
        payload: { $ref: "#/components/schemas/TransferMovePrefixPayload" }

    JobProgress:
      type: object
      properties:
        objectsDone: { type: integer, format: int64 }
        objectsTotal: { type: integer, format: int64, nullable: true }
        objectsPerSecond: { type: integer, format: int64, nullable: true }
        bytesDone: { type: integer, format: int64 }
        bytesTotal: { type: integer, format: int64, nullable: true }
        speedBps: { type: integer, format: int64, nullable: true }
        etaSeconds: { type: integer, nullable: true }

    Job:
      type: object
      required: [id, type, status, payload, createdAt]
      properties:
        id: { type: string }
        type: { $ref: "#/components/schemas/JobType" }
        status: { $ref: "#/components/schemas/JobStatus" }
        payload:
          type: object
          additionalProperties: true
        progress: { $ref: "#/components/schemas/JobProgress" }
        error: { type: string, nullable: true }
        errorCode: { type: string, nullable: true }
        createdAt: { type: string, format: date-time }
        startedAt: { type: string, format: date-time, nullable: true }
        finishedAt: { type: string, format: date-time, nullable: true }

    JobCreateRequest:
      oneOf:
        - $ref: "#/components/schemas/JobCreateRequestTransferSyncLocalToS3"
        - $ref: "#/components/schemas/JobCreateRequestTransferSyncStagingToS3"
        - $ref: "#/components/schemas/JobCreateRequestTransferSyncS3ToLocal"
        - $ref: "#/components/schemas/JobCreateRequestTransferDeletePrefix"
        - $ref: "#/components/schemas/JobCreateRequestS3ZipPrefix"
        - $ref: "#/components/schemas/JobCreateRequestS3ZipObjects"
        - $ref: "#/components/schemas/JobCreateRequestS3DeleteObjects"
        - $ref: "#/components/schemas/JobCreateRequestS3IndexObjects"
        - $ref: "#/components/schemas/JobCreateRequestTransferCopyObject"
        - $ref: "#/components/schemas/JobCreateRequestTransferMoveObject"
        - $ref: "#/components/schemas/JobCreateRequestTransferCopyBatch"
        - $ref: "#/components/schemas/JobCreateRequestTransferMoveBatch"
        - $ref: "#/components/schemas/JobCreateRequestTransferCopyPrefix"
        - $ref: "#/components/schemas/JobCreateRequestTransferMovePrefix"
      discriminator:
        propertyName: type
        mapping:
          transfer_sync_local_to_s3: "#/components/schemas/JobCreateRequestTransferSyncLocalToS3"
          transfer_sync_staging_to_s3: "#/components/schemas/JobCreateRequestTransferSyncStagingToS3"
          transfer_sync_s3_to_local: "#/components/schemas/JobCreateRequestTransferSyncS3ToLocal"
          transfer_delete_prefix: "#/components/schemas/JobCreateRequestTransferDeletePrefix"
          s3_zip_prefix: "#/components/schemas/JobCreateRequestS3ZipPrefix"
          s3_zip_objects: "#/components/schemas/JobCreateRequestS3ZipObjects"
          s3_delete_objects: "#/components/schemas/JobCreateRequestS3DeleteObjects"
          s3_index_objects: "#/components/schemas/JobCreateRequestS3IndexObjects"
          transfer_copy_object: "#/components/schemas/JobCreateRequestTransferCopyObject"
          transfer_move_object: "#/components/schemas/JobCreateRequestTransferMoveObject"
          transfer_copy_batch: "#/components/schemas/JobCreateRequestTransferCopyBatch"
          transfer_move_batch: "#/components/schemas/JobCreateRequestTransferMoveBatch"
          transfer_copy_prefix: "#/components/schemas/JobCreateRequestTransferCopyPrefix"
          transfer_move_prefix: "#/components/schemas/JobCreateRequestTransferMovePrefix"

    JobCreatedResponse:
      type: object
      required: [jobId]
      properties:
        jobId: { type: string }

    JobsListResponse:
      type: object
      required: [items]
      properties:
        items:
          type: array
          items: { $ref: "#/components/schemas/Job" }
        nextCursor: { type: string, nullable: true }

    MetaResponse:
      type: object
      required:
        - version
        - serverAddr
        - dataDir
        - staticDir
        - apiTokenEnabled
        - encryptionEnabled
        - capabilities
        - jobConcurrency
        - uploadSessionTTLSeconds
        - transferEngine
      properties:
        version: { type: string }
        serverAddr: { type: string }
        dataDir: { type: string }
        staticDir: { type: string }
        apiTokenEnabled: { type: boolean }
        encryptionEnabled: { type: boolean }
        capabilities: { $ref: "#/components/schemas/MetaCapabilities" }
        allowedLocalDirs:
          type: array
          items: { type: string }
        jobConcurrency: { type: integer }
        jobLogMaxBytes: { type: integer, format: int64, nullable: true }
        jobRetentionSeconds: { type: integer, format: int64, nullable: true }
        jobLogRetentionSeconds: { type: integer, format: int64, nullable: true }
        uploadSessionTTLSeconds: { type: integer, format: int64 }
        uploadMaxBytes: { type: integer, format: int64, nullable: true }
        uploadDirectStream: { type: boolean }
        transferEngine:
          type: object
          required: [name, available, compatible, minVersion]
          properties:
            name: { type: string }
            available: { type: boolean }
            compatible: { type: boolean }
            minVersion: { type: string }
            path: { type: string }
            version: { type: string }

    MetaCapabilities:
      type: object
      required: [profileTls]
      properties:
        profileTls: { $ref: "#/components/schemas/FeatureCapability" }

    FeatureCapability:
      type: object
      required: [enabled]
      properties:
        enabled: { type: boolean }
        reason: { type: string }
