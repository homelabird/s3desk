stages:
  - test
  - audit

# Mandatory quality gate.
check:
  stage: test
  image: golang:1.23
  before_script:
    - apt-get update
    - apt-get install -y --no-install-recommends python3 ca-certificates curl git gnupg
    - curl -fsSL https://deb.nodesource.com/setup_22.x | bash -
    - apt-get install -y --no-install-recommends nodejs
    - node --version
    - npm --version
  script:
    - bash scripts/check.sh
    # Ensure generated artifacts (openapi types, third-party notices) are committed.
    - git diff --exit-code
  artifacts:
    when: always
    paths:
      - THIRD_PARTY_NOTICES.md
      - third_party/licenses/
    expire_in: 7 days

e2e:
  stage: test
  image: docker:27.3.1
  services:
    - name: docker:27.3.1-dind
      command: ["--tls=false"]
  variables:
    DOCKER_HOST: "tcp://docker:2375"
    DOCKER_TLS_CERTDIR: ""
  script:
    - docker version
    - docker compose -f docker-compose.e2e.yml up --build --abort-on-container-exit --exit-code-from runner
  after_script:
    - if [ "$CI_JOB_STATUS" != "success" ]; then docker compose -f docker-compose.e2e.yml logs --no-color; fi
    - docker compose -f docker-compose.e2e.yml down -v

perf_tests:
  stage: test
  image: mcr.microsoft.com/playwright:v1.47.0-jammy
  rules:
    - if: '$PERF_TESTS == "1"'
      when: on_success
    - when: never
  script:
    - apt-get update
    - apt-get install -y --no-install-recommends ca-certificates curl gnupg
    - curl -fsSL https://deb.nodesource.com/setup_22.x | bash -
    - apt-get install -y --no-install-recommends nodejs
    - node --version
    - npm --version
    - cd frontend
    - npm ci --no-audit --no-fund
    - PERF_TESTS=1 npx playwright test tests/jobs-perf.spec.ts
  artifacts:
    when: always
    paths:
      - frontend/test-results/
      - frontend/playwright-report/
    expire_in: 7 days

dev_license_audit:
  stage: audit
  image: golang:1.23
  before_script:
    - apt-get update
    - apt-get install -y --no-install-recommends python3 ca-certificates curl git gnupg
    - curl -fsSL https://deb.nodesource.com/setup_22.x | bash -
    - apt-get install -y --no-install-recommends nodejs
    - node --version
    - npm --version
  script:
    - cd frontend
    - npm ci --no-audit --no-fund
    - cd ..
    - python3 scripts/generate_third_party_notices.py --include-dev
  artifacts:
    when: always
    paths:
      - THIRD_PARTY_NOTICES.md
      - third_party/licenses/
    expire_in: 7 days
