workflow:
  rules:
    - if: '$CI_COMMIT_TAG'
      when: always
    - changes:
        - .gitlab-ci.yml
        - Containerfile
        - docker-compose*.yml
        - openapi.yml
        - backend/**/*
        - charts/**/*
        - e2e/**/*
        - frontend/**/*
        - k8s/**/*
        - scripts/**/*
        - third_party/licenses-manual/**/*
        - third_party/licenses/**/*
      when: always
    - changes:
        - README.md
        - LICENSE*
        - docs/**/*
        - docs/wiki/**/*
      when: never
    - when: never

default:
  tags:
    - onpremise
    - k8s

stages:
  - build
  - test
  - audit
  - publish

variables:
  NPM_VERSION: "10.9.4"

openapi_validate:
  stage: test
  image: harbor.k8s.homelabird.com/library/golang:1.24
  script:
    - bash scripts/validate_openapi.sh

check:
  stage: test
  image: harbor.k8s.homelabird.com/library/golang:1.24
  before_script:
    - apt-get update
    - apt-get install -y --no-install-recommends python3 ca-certificates curl git gnupg
    - curl -fsSL https://deb.nodesource.com/setup_22.x | bash -
    - apt-get install -y --no-install-recommends nodejs
    - node --version
    - npm install -g "npm@${NPM_VERSION}"
    - npm --version
  script:
    - bash scripts/check.sh

build_s3desk_image:
  stage: build
  image: quay.io/podman/stable:latest
  rules:
    - changes:
        - Containerfile
        - docker-compose.e2e.yml
        - backend/**/*
        - e2e/**/*
        - frontend/**/*
        - openapi.yml
    - when: never
  variables:
    STORAGE_DRIVER: "vfs"
    CONTAINERS_STORAGE_DRIVER: "vfs"
    BUILDAH_ISOLATION: "chroot"
    HARBOR_REGISTRY: "harbor.k8s.homelabird.com"
    S3DESK_IMAGE: "${HARBOR_REGISTRY}/library/s3desk:${CI_COMMIT_SHA}"
  before_script:
    - |
      if [ -z "$HARBOR_USERNAME" ] || [ -z "$HARBOR_PASSWORD" ]; then
        echo "HARBOR_USERNAME/HARBOR_PASSWORD are required to push images." >&2
        exit 1
      fi
      podman login "$HARBOR_REGISTRY" -u "$HARBOR_USERNAME" -p "$HARBOR_PASSWORD"
      if ! command -v curl >/dev/null 2>&1; then
        if command -v dnf >/dev/null 2>&1; then
          dnf -y install curl
        elif command -v apk >/dev/null 2>&1; then
          apk add --no-cache curl
        elif command -v apt-get >/dev/null 2>&1; then
          apt-get update
          apt-get install -y --no-install-recommends curl
        fi
      fi
  script:
    - |
      tag="${CI_COMMIT_SHA}"
      repo="library/s3desk"
      encoded_pass=$(printf '%s' "$HARBOR_USERNAME:$HARBOR_PASSWORD" | base64 | tr -d '\n')
      if curl -fsS -H "Authorization: Basic ${encoded_pass}" \
        "https://${HARBOR_REGISTRY}/v2/${repo}/manifests/${tag}" >/dev/null; then
        echo "Harbor already has ${repo}:${tag}; skipping build/push."
        exit 0
      fi
    - podman build -t "$S3DESK_IMAGE" -f Containerfile .
    - podman push "$S3DESK_IMAGE"

gofmt:
  stage: test
  image: harbor.k8s.homelabird.com/library/golang:1.24
  script:
    - |
      UNFORMATTED=$(find backend -name '*.go' -type f -print0 | xargs -0 gofmt -l)
      if [ -n "$UNFORMATTED" ]; then
        echo "[gofmt] needed:" >&2
        echo "$UNFORMATTED" >&2
        exit 1
      fi

go_test:
  stage: test
  image: harbor.k8s.homelabird.com/library/golang:1.24
  variables:
    KUBERNETES_MEMORY_REQUEST: "1Gi"
    KUBERNETES_MEMORY_LIMIT: "2Gi"
  script:
    - cd backend
    - go vet ./...
    - go test ./...

govulncheck:
  stage: test
  image: harbor.k8s.homelabird.com/library/golang:1.24
  script:
    - |
      GOBIN="$(go env GOBIN)"
      if [ -z "$GOBIN" ]; then
        GOBIN="$(go env GOPATH)/bin"
      fi
      go install golang.org/x/vuln/cmd/govulncheck@latest
      cd backend
      "$GOBIN/govulncheck" ./...

frontend_openapi_types:
  stage: test
  image: harbor.k8s.homelabird.com/library/node:22-bookworm
  script:
    - cd frontend
    - npm install -g "npm@${NPM_VERSION}"
    - npm --version
    - npm ci --no-audit --no-fund
    - npm run gen:openapi
    - cd ..
    - git diff --exit-code frontend/src/api/openapi.ts

frontend_lint:
  stage: test
  image: harbor.k8s.homelabird.com/library/node:22-bookworm
  script:
    - cd frontend
    - npm install -g "npm@${NPM_VERSION}"
    - npm --version
    - npm ci --no-audit --no-fund
    - npm run gen:openapi
    - npm run lint

frontend_build:
  stage: test
  image: harbor.k8s.homelabird.com/library/node:22-bookworm
  variables:
    NODE_OPTIONS: "--max-old-space-size=2048"
    KUBERNETES_MEMORY_REQUEST: "1Gi"
    KUBERNETES_MEMORY_LIMIT: "2Gi"
  script:
    - cd frontend
    - npm install -g "npm@${NPM_VERSION}"
    - npm --version
    - npm ci --no-audit --no-fund
    - npm run gen:openapi
    - npm run build

third_party_notices:
  stage: audit
  image: harbor.k8s.homelabird.com/library/golang:1.24
  before_script:
    - apt-get update
    - apt-get install -y --no-install-recommends python3 ca-certificates curl git gnupg
    - curl -fsSL https://deb.nodesource.com/setup_22.x | bash -
    - apt-get install -y --no-install-recommends nodejs
    - node --version
    - npm install -g "npm@${NPM_VERSION}"
    - npm --version
  script:
    - cd frontend
    - npm ci --no-audit --no-fund
    - cd ..
    - python3 scripts/generate_third_party_notices.py
    # Ignore the Generated at timestamp since it is time-dependent.
    - git diff --exit-code -I '^Generated at '
  artifacts:
    when: always
    paths:
      - THIRD_PARTY_NOTICES.md
      - third_party/licenses/
    expire_in: 7 days

api_integration:
  stage: test
  image: quay.io/podman/stable:latest
  rules:
    - changes:
        - backend/**/*
        - e2e/api/**/*
        - openapi.yml
        - docker-compose.e2e.yml
    - when: never
  variables:
    STORAGE_DRIVER: "vfs"
    CONTAINERS_STORAGE_DRIVER: "vfs"
    BUILDAH_ISOLATION: "chroot"
    PODMAN_NETWORK_BACKEND: "slirp4netns"
    CONTAINERS_NETWORK_BACKEND: "slirp4netns"
    HARBOR_REGISTRY: "harbor.k8s.homelabird.com"
    S3DESK_IMAGE: "${HARBOR_REGISTRY}/library/s3desk:${CI_COMMIT_SHA}"
    E2E_BASE_URL: "http://s3desk:8080"
    E2E_MINIO_ENDPOINT: "http://minio:9000"
    E2E_AZURITE_ENDPOINT: "http://azurite:10000/devstoreaccount1"
    E2E_GCS_ENDPOINT: "http://fake-gcs-server:4443/storage/v1/v1"
  before_script:
    - |
      set -e
      export XDG_CONFIG_HOME="/tmp"
      mkdir -p "${XDG_CONFIG_HOME}/containers"
      cat > "${XDG_CONFIG_HOME}/containers/containers.conf" <<'EOF'
      [network]
      default_rootless_network_cmd = "slirp4netns"
      EOF
      if ! command -v slirp4netns >/dev/null 2>&1; then
        if command -v dnf >/dev/null 2>&1; then
          dnf -y install slirp4netns
        elif command -v apk >/dev/null 2>&1; then
          apk add --no-cache slirp4netns
        elif command -v apt-get >/dev/null 2>&1; then
          apt-get update
          apt-get install -y --no-install-recommends slirp4netns
        fi
      fi
      if command -v podman-compose >/dev/null 2>&1; then
        COMPOSE_CMD="podman-compose"
        COMPOSE_ARGS="--in-pod s3desk-e2e --pod-args=--network=slirp4netns"
        COMPOSE_PULL_ARGS=""
      else
        if command -v dnf >/dev/null 2>&1; then
          dnf -y install python3-pip
        elif command -v apk >/dev/null 2>&1; then
          apk add --no-cache python3 py3-pip
        elif command -v apt-get >/dev/null 2>&1; then
          apt-get update
          apt-get install -y --no-install-recommends python3 python3-pip
        fi
        python3 -m pip install --no-cache-dir podman-compose
        COMPOSE_CMD="podman-compose"
        COMPOSE_ARGS="--in-pod s3desk-e2e --pod-args=--network=slirp4netns"
        COMPOSE_PULL_ARGS=""
      fi
      echo "$COMPOSE_CMD" > /tmp/compose_cmd
      echo "$COMPOSE_ARGS" > /tmp/compose_args
      echo "$COMPOSE_PULL_ARGS" > /tmp/compose_pull_args
      if [ "$COMPOSE_CMD" = "podman-compose" ]; then
        echo "logs" > /tmp/compose_logs_cmd
      else
        echo "logs --no-color" > /tmp/compose_logs_cmd
      fi
  script:
    - podman --version
    - |
      if [ -n "$HARBOR_USERNAME" ] && [ -n "$HARBOR_PASSWORD" ]; then
        podman login "$HARBOR_REGISTRY" -u "$HARBOR_USERNAME" -p "$HARBOR_PASSWORD"
      fi
    - |
      for image in \
        "$S3DESK_IMAGE" \
        "harbor.k8s.homelabird.com/library/minio/minio:RELEASE.2025-09-07T16-13-09Z" \
        "harbor.k8s.homelabird.com/library/azurite:3.33.0" \
        "harbor.k8s.homelabird.com/library/fsouza/fake-gcs-server:1.47.7"; do \
        if ! podman image exists "$image"; then \
          podman pull "$image"; \
        fi; \
      done
    - COMPOSE_CMD="$(cat /tmp/compose_cmd)" COMPOSE_ARGS="$(cat /tmp/compose_args)" COMPOSE_PULL_ARGS="$(cat /tmp/compose_pull_args)" && $COMPOSE_CMD $COMPOSE_ARGS $COMPOSE_PULL_ARGS -f docker-compose.e2e.yml up --abort-on-container-exit --exit-code-from runner
  after_script:
    - |
      COMPOSE_CMD="$(cat /tmp/compose_cmd)"
      COMPOSE_ARGS="$(cat /tmp/compose_args)"
      COMPOSE_PULL_ARGS="$(cat /tmp/compose_pull_args)"
      LOGS_CMD="$(cat /tmp/compose_logs_cmd)"
      if [ "$CI_JOB_STATUS" != "success" ]; then $COMPOSE_CMD $COMPOSE_ARGS $COMPOSE_PULL_ARGS -f docker-compose.e2e.yml $LOGS_CMD; fi
      $COMPOSE_CMD $COMPOSE_ARGS $COMPOSE_PULL_ARGS -f docker-compose.e2e.yml down -v

frontend_unit_tests:
  stage: test
  image: harbor.k8s.homelabird.com/library/node:22-bookworm
  variables:
    NODE_OPTIONS: "--max-old-space-size=2048"
    KUBERNETES_MEMORY_REQUEST: "1Gi"
    KUBERNETES_MEMORY_LIMIT: "2Gi"
  script:
    - cd frontend
    - npm install -g "npm@${NPM_VERSION}"
    - npm --version
    - npm ci --no-audit --no-fund
    - npm run test:unit

e2e:
  stage: test
  image: mcr.microsoft.com/playwright:v1.47.0-jammy
  rules:
    - if: '$E2E_BASE_URL'
      when: on_success
    - when: never
  script:
    - |
      if [ -z "$E2E_BASE_URL" ]; then
        echo "E2E_BASE_URL is required to run E2E tests in CI."
        exit 1
      fi
    - export PLAYWRIGHT_BASE_URL="$E2E_BASE_URL"
    - cd frontend
    - npm install -g "npm@${NPM_VERSION}"
    - npm --version
    - npm ci --no-audit --no-fund
    - npx playwright test tests/objects-smoke.spec.ts tests/docs-smoke.spec.ts tests/transfers-*.spec.ts
  artifacts:
    when: always
    paths:
      - frontend/test-results/
      - frontend/playwright-report/
    expire_in: 7 days

perf_tests:
  stage: test
  image: mcr.microsoft.com/playwright:v1.47.0-jammy
  rules:
    - if: '$PERF_TESTS == "1"'
      when: on_success
    - when: never
  script:
    - apt-get update
    - apt-get install -y --no-install-recommends ca-certificates curl gnupg
    - curl -fsSL https://deb.nodesource.com/setup_22.x | bash -
    - apt-get install -y --no-install-recommends nodejs
    - node --version
    - npm install -g "npm@${NPM_VERSION}"
    - npm --version
    - cd frontend
    - npm ci --no-audit --no-fund
    - PERF_TESTS=1 npx playwright test tests/jobs-perf.spec.ts
  artifacts:
    when: always
    paths:
      - frontend/test-results/
      - frontend/playwright-report/
    expire_in: 7 days

dev_license_audit:
  stage: audit
  image: harbor.k8s.homelabird.com/library/golang:1.24
  before_script:
    - apt-get update
    - apt-get install -y --no-install-recommends python3 ca-certificates curl git gnupg
    - curl -fsSL https://deb.nodesource.com/setup_22.x | bash -
    - apt-get install -y --no-install-recommends nodejs
    - node --version
    - npm install -g "npm@${NPM_VERSION}"
    - npm --version
  script:
    - cd frontend
    - npm ci --no-audit --no-fund
    - cd ..
    - python3 scripts/generate_third_party_notices.py --include-dev
  artifacts:
    when: always
    paths:
      - THIRD_PARTY_NOTICES.md
      - third_party/licenses/
    expire_in: 7 days

trivy_scan:
  stage: audit
  image: aquasec/trivy:0.56.2
  rules:
    - if: '$CI_COMMIT_TAG'
      when: on_success
    - when: never
  variables:
    HARBOR_REGISTRY: "harbor.k8s.homelabird.com"
    S3DESK_IMAGE: "${HARBOR_REGISTRY}/library/s3desk:${CI_COMMIT_SHA}"
  script:
    - |
      if [ -z "$HARBOR_USERNAME" ] || [ -z "$HARBOR_PASSWORD" ]; then
        echo "HARBOR_USERNAME/HARBOR_PASSWORD are required for trivy scan." >&2
        exit 1
      fi
      trivy image \
        --severity HIGH,CRITICAL \
        --exit-code 0 \
        --ignore-unfixed \
        --username "$HARBOR_USERNAME" \
        --password "$HARBOR_PASSWORD" \
        "$S3DESK_IMAGE"

publish_dockerhub:
  stage: publish
  image: quay.io/podman/stable:latest
  variables:
    STORAGE_DRIVER: "vfs"
    CONTAINERS_STORAGE_DRIVER: "vfs"
    BUILDAH_ISOLATION: "chroot"
    SKIP_DOCKERHUB_DESCRIPTION: "1"
  needs:
    - trivy_scan
  rules:
    - if: '$CI_COMMIT_TAG'
  script:
    - echo "$DOCKERHUB_TOKEN" | podman login -u "$DOCKERHUB_USERNAME" --password-stdin docker.io
    - |
      DOCKERHUB_REPO="$(printf '%s' "$DOCKERHUB_REPO" | tr -d '\r\n' | sed -e 's/^[[:space:]]*//' -e 's/[[:space:]]*$//')"
      DOCKERHUB_REPO="${DOCKERHUB_REPO#https://}"
      DOCKERHUB_REPO="${DOCKERHUB_REPO#http://}"
      DOCKERHUB_REPO="${DOCKERHUB_REPO#docker.io/}"
      DOCKERHUB_REPO="${DOCKERHUB_REPO#index.docker.io/}"
      DOCKERHUB_REPO="${DOCKERHUB_REPO#registry-1.docker.io/}"
      if [ -z "$DOCKERHUB_REPO" ]; then
        echo "DOCKERHUB_REPO is empty after normalization." >&2
        exit 1
      fi
      if ! printf '%s' "$DOCKERHUB_REPO" | grep -Eq '^[a-z0-9]+([._-][a-z0-9]+)*/[a-z0-9]+([._-][a-z0-9]+)*$'; then
        echo "DOCKERHUB_REPO must be in the form 'namespace/repo' (lowercase, no scheme)." >&2
        exit 1
      fi
      TAG="$CI_COMMIT_TAG"
      BASE_TAG="$TAG"
      case "$TAG" in
        *-postgres) BASE_TAG="${TAG%-postgres}" ;;
        *-sqlite) BASE_TAG="${TAG%-sqlite}" ;;
      esac
      for DB_BACKEND in postgres sqlite; do
        if [ "$DB_BACKEND" = "postgres" ]; then
          SUFFIX_TAG="${BASE_TAG}-postgres"
          BETA_TAG="beta-postgres"
          LEGACY_TAG="postgres-beta"
        else
          SUFFIX_TAG="${BASE_TAG}-sqlite"
          BETA_TAG="beta-sqlite"
          LEGACY_TAG=""
        fi
        podman build --build-arg DB_BACKEND="$DB_BACKEND" -f Containerfile \
          -t "$DOCKERHUB_REPO:$SUFFIX_TAG" \
          -t "$DOCKERHUB_REPO:$BETA_TAG" \
          ${LEGACY_TAG:+-t "$DOCKERHUB_REPO:$LEGACY_TAG"} .
        podman push "$DOCKERHUB_REPO:$SUFFIX_TAG"
        podman push "$DOCKERHUB_REPO:$BETA_TAG"
        if [ -n "$LEGACY_TAG" ]; then
          podman push "$DOCKERHUB_REPO:$LEGACY_TAG"
        fi
      done
    - |
      if [ "${SKIP_DOCKERHUB_DESCRIPTION:-0}" = "1" ]; then
        echo "Skipping Docker Hub description upload (SKIP_DOCKERHUB_DESCRIPTION=1)."
        exit 0
      fi
      if ! command -v curl >/dev/null 2>&1; then
        if command -v dnf >/dev/null 2>&1; then
          dnf -y install curl
        elif command -v apk >/dev/null 2>&1; then
          apk add --no-cache curl
        elif command -v apt-get >/dev/null 2>&1; then
          apt-get update
          apt-get install -y --no-install-recommends curl
        fi
      fi
      if ! command -v python3 >/dev/null 2>&1; then
        if command -v dnf >/dev/null 2>&1; then
          dnf -y install python3
        elif command -v apk >/dev/null 2>&1; then
          apk add --no-cache python3
        elif command -v apt-get >/dev/null 2>&1; then
          apt-get update
          apt-get install -y --no-install-recommends python3
        fi
      fi
      README_FILEPATH="${README_FILEPATH:-$CI_PROJECT_DIR/README.md}"
      export README_FILEPATH
      token="$(curl -fsS -H 'Content-Type: application/json' \
        -d "{\"username\":\"${DOCKERHUB_USERNAME}\",\"password\":\"${DOCKERHUB_TOKEN}\"}" \
        https://hub.docker.com/v2/users/login/ | python3 -c 'import sys,json; print(json.load(sys.stdin)["token"])')"
      payload="$(python3 -c 'import json,os; path=os.environ.get("README_FILEPATH"); print(json.dumps({"full_description": open(path, "r", encoding="utf-8").read()}))')"
      curl -fsS -X PATCH \
        -H "Content-Type: application/json" \
        -H "Authorization: JWT ${token}" \
        --data-binary "${payload}" \
        "https://hub.docker.com/v2/repositories/${DOCKERHUB_REPO}/"
