workflow:
  rules:
    - if: '$CI_COMMIT_TAG'
      when: always
    - changes:
        - .gitlab-ci.yml
        - Containerfile
        - docker-compose*.yml
        - openapi.yml
        - backend/**/*
        - charts/**/*
        - e2e/**/*
        - frontend/**/*
        - k8s/**/*
        - scripts/**/*
        - third_party/licenses-manual/**/*
        - third_party/licenses/**/*
      when: always
    - changes:
        - README.md
        - LICENSE*
        - docs/**/*
        - docs/wiki/**/*
      when: never
    - when: never

default:
  tags:
    - onpremise
    - k8s

stages:
  - test
  - audit
  - publish

# Mandatory quality gate.
check:
  stage: test
  image: golang:1.24
  before_script:
    - apt-get update
    - apt-get install -y --no-install-recommends python3 ca-certificates curl git gnupg
    - curl -fsSL https://deb.nodesource.com/setup_22.x | bash -
    - apt-get install -y --no-install-recommends nodejs
    - node --version
    - npm --version
  script:
    - bash scripts/check.sh
    - |
      GOBIN="$(go env GOBIN)"
      if [ -z "$GOBIN" ]; then
        GOBIN="$(go env GOPATH)/bin"
      fi
      go install golang.org/x/vuln/cmd/govulncheck@latest
      cd backend
      "$GOBIN/govulncheck" ./...
    # Ensure generated artifacts (openapi types, third-party notices) are committed.
    # Ignore the Generated at timestamp since it is time-dependent.
    - git diff --exit-code -I '^Generated at '
  artifacts:
    when: always
    paths:
      - THIRD_PARTY_NOTICES.md
      - third_party/licenses/
    expire_in: 7 days

e2e:
  stage: test
  image: quay.io/podman/stable:latest
  variables:
    STORAGE_DRIVER: "vfs"
    CONTAINERS_STORAGE_DRIVER: "vfs"
    BUILDAH_ISOLATION: "chroot"
    PODMAN_NETWORK_BACKEND: "slirp4netns"
    CONTAINERS_NETWORK_BACKEND: "slirp4netns"
  before_script:
    - |
      set -e
      if ! command -v slirp4netns >/dev/null 2>&1; then
        if command -v dnf >/dev/null 2>&1; then
          dnf -y install slirp4netns
        elif command -v apk >/dev/null 2>&1; then
          apk add --no-cache slirp4netns
        elif command -v apt-get >/dev/null 2>&1; then
          apt-get update
          apt-get install -y --no-install-recommends slirp4netns
        fi
      fi
      if podman compose version >/dev/null 2>&1; then
        COMPOSE_CMD="podman compose"
      elif command -v podman-compose >/dev/null 2>&1; then
        COMPOSE_CMD="podman-compose"
      else
        if command -v dnf >/dev/null 2>&1; then
          dnf -y install python3-pip
        elif command -v apk >/dev/null 2>&1; then
          apk add --no-cache python3 py3-pip
        elif command -v apt-get >/dev/null 2>&1; then
          apt-get update
          apt-get install -y --no-install-recommends python3 python3-pip
        fi
        python3 -m pip install --no-cache-dir podman-compose
        COMPOSE_CMD="podman-compose"
      fi
      echo "$COMPOSE_CMD" > /tmp/compose_cmd
  script:
    - podman --version
    - COMPOSE_CMD="$(cat /tmp/compose_cmd)" && $COMPOSE_CMD -f docker-compose.e2e.yml up --build --abort-on-container-exit --exit-code-from runner
  after_script:
    - |
      COMPOSE_CMD="$(cat /tmp/compose_cmd)"
      if [ "$CI_JOB_STATUS" != "success" ]; then $COMPOSE_CMD -f docker-compose.e2e.yml logs --no-color; fi
      $COMPOSE_CMD -f docker-compose.e2e.yml down -v

perf_tests:
  stage: test
  image: mcr.microsoft.com/playwright:v1.47.0-jammy
  rules:
    - if: '$PERF_TESTS == "1"'
      when: on_success
    - when: never
  script:
    - apt-get update
    - apt-get install -y --no-install-recommends ca-certificates curl gnupg
    - curl -fsSL https://deb.nodesource.com/setup_22.x | bash -
    - apt-get install -y --no-install-recommends nodejs
    - node --version
    - npm --version
    - cd frontend
    - npm ci --no-audit --no-fund
    - PERF_TESTS=1 npx playwright test tests/jobs-perf.spec.ts
  artifacts:
    when: always
    paths:
      - frontend/test-results/
      - frontend/playwright-report/
    expire_in: 7 days

dev_license_audit:
  stage: audit
  image: golang:1.24
  before_script:
    - apt-get update
    - apt-get install -y --no-install-recommends python3 ca-certificates curl git gnupg
    - curl -fsSL https://deb.nodesource.com/setup_22.x | bash -
    - apt-get install -y --no-install-recommends nodejs
    - node --version
    - npm --version
  script:
    - cd frontend
    - npm ci --no-audit --no-fund
    - cd ..
    - python3 scripts/generate_third_party_notices.py --include-dev
  artifacts:
    when: always
    paths:
      - THIRD_PARTY_NOTICES.md
      - third_party/licenses/
    expire_in: 7 days

publish_dockerhub:
  stage: publish
  image: docker:27.3.1
  services:
    - name: docker:27.3.1-dind
      command: ["--tls=false"]
  variables:
    DOCKER_HOST: "tcp://docker:2375"
    DOCKER_TLS_CERTDIR: ""
  rules:
    - if: '$CI_COMMIT_TAG'
  script:
    - echo "$DOCKERHUB_TOKEN" | docker login -u "$DOCKERHUB_USERNAME" --password-stdin
    - docker build -f Containerfile -t "$DOCKERHUB_REPO:$CI_COMMIT_TAG" -t "$DOCKERHUB_REPO:beta" .
    - docker push "$DOCKERHUB_REPO:$CI_COMMIT_TAG"
    - docker push "$DOCKERHUB_REPO:beta"
    - docker run --rm -v "$CI_PROJECT_DIR":/workspace \
        -e DOCKERHUB_USERNAME \
        -e DOCKERHUB_PASSWORD="$DOCKERHUB_TOKEN" \
        -e DOCKERHUB_REPOSITORY="$DOCKERHUB_REPO" \
        -e README_FILEPATH=/workspace/README.md \
        peterevans/dockerhub-description:latest
