stages:
  - test
  - audit

# Mandatory quality gate.
check:
  stage: test
  image: golang:1.23
  before_script:
    - apt-get update
    - apt-get install -y --no-install-recommends nodejs npm python3 ca-certificates curl git
  script:
    - bash scripts/check.sh
    # Ensure generated artifacts (openapi types, third-party notices) are committed.
    - git diff --exit-code
  artifacts:
    when: always
    paths:
      - THIRD_PARTY_NOTICES.md
      - third_party/licenses/
    expire_in: 7 days

perf_tests:
  stage: test
  image: mcr.microsoft.com/playwright:v1.47.0-jammy
  rules:
    - if: '$PERF_TESTS == "1"'
      when: on_success
    - when: never
  script:
    - cd frontend
    - npm ci --no-audit --no-fund
    - PERF_TESTS=1 npx playwright test tests/jobs-perf.spec.ts
  artifacts:
    when: always
    paths:
      - frontend/test-results/
      - frontend/playwright-report/
    expire_in: 7 days

dev_license_audit:
  stage: audit
  image: golang:1.23
  before_script:
    - apt-get update
    - apt-get install -y --no-install-recommends nodejs npm python3 ca-certificates curl
  script:
    - cd frontend
    - npm ci --no-audit --no-fund
    - cd ..
    - python3 scripts/generate_third_party_notices.py --include-dev
  artifacts:
    when: always
    paths:
      - THIRD_PARTY_NOTICES.md
      - third_party/licenses/
    expire_in: 7 days
