workflow:
  rules:
    - if: '$CI_COMMIT_TAG'
      when: always
    - changes:
        - .gitlab-ci.yml
        - Containerfile
        - docker-compose*.yml
        - openapi.yml
        - backend/**/*
        - charts/**/*
        - e2e/**/*
        - frontend/**/*
        - k8s/**/*
        - scripts/**/*
        - third_party/licenses-manual/**/*
        - third_party/licenses/**/*
      when: always
    - changes:
        - README.md
        - LICENSE*
        - docs/**/*
        - docs/wiki/**/*
      when: never
    - when: never

default:
  tags:
    - onpremise
    - k8s

stages:
  - test
  - audit
  - publish

openapi_validate:
  stage: test
  image: harbor.k8s.homelabird.com/library/golang:1.24
  script:
    - bash scripts/validate_openapi.sh

gofmt:
  stage: test
  image: harbor.k8s.homelabird.com/library/golang:1.24
  script:
    - |
      UNFORMATTED=$(find backend -name '*.go' -type f -print0 | xargs -0 gofmt -l)
      if [ -n "$UNFORMATTED" ]; then
        echo "[gofmt] needed:" >&2
        echo "$UNFORMATTED" >&2
        exit 1
      fi

go_test:
  stage: test
  image: harbor.k8s.homelabird.com/library/golang:1.24
  variables:
    KUBERNETES_MEMORY_REQUEST: "1Gi"
    KUBERNETES_MEMORY_LIMIT: "2Gi"
  script:
    - cd backend
    - go vet ./...
    - go test ./...

govulncheck:
  stage: test
  image: harbor.k8s.homelabird.com/library/golang:1.24
  script:
    - |
      GOBIN="$(go env GOBIN)"
      if [ -z "$GOBIN" ]; then
        GOBIN="$(go env GOPATH)/bin"
      fi
      go install golang.org/x/vuln/cmd/govulncheck@latest
      cd backend
      "$GOBIN/govulncheck" ./...

frontend_openapi_types:
  stage: test
  image: harbor.k8s.homelabird.com/library/node:22-bookworm
  script:
    - cd frontend
    - npm ci --no-audit --no-fund
    - npm run gen:openapi
    - cd ..
    - git diff --exit-code frontend/src/api/openapi.ts

frontend_lint:
  stage: test
  image: harbor.k8s.homelabird.com/library/node:22-bookworm
  script:
    - cd frontend
    - npm ci --no-audit --no-fund
    - npm run gen:openapi
    - npm run lint

frontend_build:
  stage: test
  image: harbor.k8s.homelabird.com/library/node:22-bookworm
  variables:
    NODE_OPTIONS: "--max-old-space-size=2048"
    KUBERNETES_MEMORY_REQUEST: "1Gi"
    KUBERNETES_MEMORY_LIMIT: "2Gi"
  script:
    - cd frontend
    - npm ci --no-audit --no-fund
    - npm run gen:openapi
    - npm run build

third_party_notices:
  stage: audit
  image: harbor.k8s.homelabird.com/library/golang:1.24
  before_script:
    - apt-get update
    - apt-get install -y --no-install-recommends python3 ca-certificates curl git gnupg
  script:
    - python3 scripts/generate_third_party_notices.py
    # Ignore the Generated at timestamp since it is time-dependent.
    - git diff --exit-code -I '^Generated at '
  artifacts:
    when: always
    paths:
      - THIRD_PARTY_NOTICES.md
      - third_party/licenses/
    expire_in: 7 days

api_integration:
  stage: test
  image: quay.io/podman/stable:latest
  variables:
    STORAGE_DRIVER: "vfs"
    CONTAINERS_STORAGE_DRIVER: "vfs"
    BUILDAH_ISOLATION: "chroot"
    PODMAN_NETWORK_BACKEND: "slirp4netns"
    CONTAINERS_NETWORK_BACKEND: "slirp4netns"
    E2E_BASE_URL: "http://127.0.0.1:8080"
    E2E_MINIO_ENDPOINT: "http://127.0.0.1:9000"
    E2E_AZURITE_ENDPOINT: "http://127.0.0.1:10000/devstoreaccount1"
    E2E_GCS_ENDPOINT: "http://127.0.0.1:4443/storage/v1/v1"
  before_script:
    - |
      set -e
      export XDG_CONFIG_HOME="/tmp"
      mkdir -p "${XDG_CONFIG_HOME}/containers"
      cat > "${XDG_CONFIG_HOME}/containers/containers.conf" <<'EOF'
      [network]
      default_rootless_network_cmd = "slirp4netns"
      EOF
      if ! command -v slirp4netns >/dev/null 2>&1; then
        if command -v dnf >/dev/null 2>&1; then
          dnf -y install slirp4netns
        elif command -v apk >/dev/null 2>&1; then
          apk add --no-cache slirp4netns
        elif command -v apt-get >/dev/null 2>&1; then
          apt-get update
          apt-get install -y --no-install-recommends slirp4netns
        fi
      fi
      if command -v podman-compose >/dev/null 2>&1; then
        COMPOSE_CMD="podman-compose"
        COMPOSE_ARGS="--in-pod s3desk-e2e --pod-args=--network=slirp4netns"
      else
        if command -v dnf >/dev/null 2>&1; then
          dnf -y install python3-pip
        elif command -v apk >/dev/null 2>&1; then
          apk add --no-cache python3 py3-pip
        elif command -v apt-get >/dev/null 2>&1; then
          apt-get update
          apt-get install -y --no-install-recommends python3 python3-pip
        fi
        python3 -m pip install --no-cache-dir podman-compose
        COMPOSE_CMD="podman-compose"
        COMPOSE_ARGS="--in-pod s3desk-e2e --pod-args=--network=slirp4netns"
      fi
      echo "$COMPOSE_CMD" > /tmp/compose_cmd
      echo "$COMPOSE_ARGS" > /tmp/compose_args
      if [ "$COMPOSE_CMD" = "podman-compose" ]; then
        echo "logs" > /tmp/compose_logs_cmd
      else
        echo "logs --no-color" > /tmp/compose_logs_cmd
      fi
  script:
    - podman --version
    - COMPOSE_CMD="$(cat /tmp/compose_cmd)" COMPOSE_ARGS="$(cat /tmp/compose_args)" && $COMPOSE_CMD $COMPOSE_ARGS -f docker-compose.e2e.yml up --build --abort-on-container-exit --exit-code-from runner
  after_script:
    - |
      COMPOSE_CMD="$(cat /tmp/compose_cmd)"
      COMPOSE_ARGS="$(cat /tmp/compose_args)"
      LOGS_CMD="$(cat /tmp/compose_logs_cmd)"
      if [ "$CI_JOB_STATUS" != "success" ]; then $COMPOSE_CMD $COMPOSE_ARGS -f docker-compose.e2e.yml $LOGS_CMD; fi
      $COMPOSE_CMD $COMPOSE_ARGS -f docker-compose.e2e.yml down -v

frontend_unit_tests:
  stage: test
  image: harbor.k8s.homelabird.com/library/node:22-bookworm
  variables:
    NODE_OPTIONS: "--max-old-space-size=2048"
    KUBERNETES_MEMORY_REQUEST: "1Gi"
    KUBERNETES_MEMORY_LIMIT: "2Gi"
  script:
    - cd frontend
    - npm ci --no-audit --no-fund
    - npm run test:unit

ui_smoke:
  stage: test
  image: mcr.microsoft.com/playwright:v1.47.0-jammy
  rules:
    - if: '$E2E_UI == "1"'
      when: on_success
    - when: never
  script:
    - |
      if [ -z "$E2E_BASE_URL" ]; then
        echo "E2E_BASE_URL is required to run UI smoke in CI."
        exit 1
      fi
    - export PLAYWRIGHT_BASE_URL="$E2E_BASE_URL"
    - cd frontend
    - npm ci --no-audit --no-fund
    - npx playwright test tests/objects-smoke.spec.ts tests/docs-smoke.spec.ts
  artifacts:
    when: always
    paths:
      - frontend/test-results/
      - frontend/playwright-report/
    expire_in: 7 days

transfer_scenarios:
  stage: test
  image: mcr.microsoft.com/playwright:v1.47.0-jammy
  rules:
    - if: '$E2E_TRANSFERS == "1"'
      when: on_success
    - when: never
  script:
    - |
      if [ -z "$E2E_BASE_URL" ]; then
        echo "E2E_BASE_URL is required to run transfer scenarios in CI."
        exit 1
      fi
    - export PLAYWRIGHT_BASE_URL="$E2E_BASE_URL"
    - cd frontend
    - npm ci --no-audit --no-fund
    - npx playwright test tests/transfers-*.spec.ts
  artifacts:
    when: always
    paths:
      - frontend/test-results/
      - frontend/playwright-report/
    expire_in: 7 days

perf_tests:
  stage: test
  image: mcr.microsoft.com/playwright:v1.47.0-jammy
  rules:
    - if: '$PERF_TESTS == "1"'
      when: on_success
    - when: never
  script:
    - apt-get update
    - apt-get install -y --no-install-recommends ca-certificates curl gnupg
    - curl -fsSL https://deb.nodesource.com/setup_22.x | bash -
    - apt-get install -y --no-install-recommends nodejs
    - node --version
    - npm --version
    - cd frontend
    - npm ci --no-audit --no-fund
    - PERF_TESTS=1 npx playwright test tests/jobs-perf.spec.ts
  artifacts:
    when: always
    paths:
      - frontend/test-results/
      - frontend/playwright-report/
    expire_in: 7 days

dev_license_audit:
  stage: audit
  image: harbor.k8s.homelabird.com/library/golang:1.24
  before_script:
    - apt-get update
    - apt-get install -y --no-install-recommends python3 ca-certificates curl git gnupg
    - curl -fsSL https://deb.nodesource.com/setup_22.x | bash -
    - apt-get install -y --no-install-recommends nodejs
    - node --version
    - npm --version
  script:
    - cd frontend
    - npm ci --no-audit --no-fund
    - cd ..
    - python3 scripts/generate_third_party_notices.py --include-dev
  artifacts:
    when: always
    paths:
      - THIRD_PARTY_NOTICES.md
      - third_party/licenses/
    expire_in: 7 days

publish_dockerhub:
  stage: publish
  image: harbor.k8s.homelabird.com/library/docker:27.3.1
  services:
    - name: harbor.k8s.homelabird.com/library/docker:27.3.1-dind
      command: ["--tls=false"]
  variables:
    DOCKER_HOST: "tcp://docker:2375"
    DOCKER_TLS_CERTDIR: ""
  rules:
    - if: '$CI_COMMIT_TAG'
  script:
    - echo "$DOCKERHUB_TOKEN" | docker login -u "$DOCKERHUB_USERNAME" --password-stdin
    - docker build -f Containerfile -t "$DOCKERHUB_REPO:$CI_COMMIT_TAG" -t "$DOCKERHUB_REPO:beta" .
    - docker push "$DOCKERHUB_REPO:$CI_COMMIT_TAG"
    - docker push "$DOCKERHUB_REPO:beta"
    - docker run --rm -v "$CI_PROJECT_DIR":/workspace \
        -e DOCKERHUB_USERNAME \
        -e DOCKERHUB_PASSWORD="$DOCKERHUB_TOKEN" \
        -e DOCKERHUB_REPOSITORY="$DOCKERHUB_REPO" \
        -e README_FILEPATH=/workspace/README.md \
        peterevans/dockerhub-description:latest
