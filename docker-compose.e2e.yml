services:
  minio:
    image: harbor.k8s.homelabird.com/library/minio/minio:latest
    command: server /data --console-address ":9001"
    environment:
      MINIO_ROOT_USER: "minioadmin"
      MINIO_ROOT_PASSWORD: "minioadmin"
    ports:
      - "9000:9000"
      - "9001:9001"
    volumes:
      - minio-data:/data

  azurite:
    image: mcr.microsoft.com/azure-storage/azurite:latest
    command: azurite-blob --blobHost 0.0.0.0 --blobPort 10000 --location /data --loose --skipApiVersionCheck
    ports:
      - "10000:10000"
    volumes:
      - azurite-data:/data

  fake-gcs-server:
    image: harbor.k8s.homelabird.com/library/fsouza/fake-gcs-server:latest
    command: ["-scheme", "http", "-port", "4443", "-backend", "memory"]
    ports:
      - "4443:4443"

  s3desk:
    build:
      context: .
      dockerfile: Containerfile
    ports:
      - "8080:8080"
    environment:
      ADDR: "0.0.0.0:8080"
      ALLOW_REMOTE: "true"
      API_TOKEN: "change-me"
      ALLOWED_HOSTS: "s3desk"
    volumes:
      - s3desk-data:/data
    depends_on:
      - minio
      - azurite
      - fake-gcs-server

  runner:
    build:
      context: ./e2e/runner
      dockerfile: Dockerfile
    environment:
      BASE_URL: "${E2E_BASE_URL:-http://s3desk:8080}"
      API_TOKEN: "change-me"
      E2E_MINIO_ENDPOINT: "${E2E_MINIO_ENDPOINT:-http://minio:9000}"
      E2E_AZURITE_ENDPOINT: "${E2E_AZURITE_ENDPOINT:-http://azurite:10000/devstoreaccount1}"
      E2E_GCS_ENDPOINT: "${E2E_GCS_ENDPOINT:-http://fake-gcs-server:4443/storage/v1/v1}"
    depends_on:
      - s3desk
    command: ["python", "/app/runner.py"]

volumes:
  minio-data:
  azurite-data:
  s3desk-data:
